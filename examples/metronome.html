<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>metronome</title>
  <meta name="author" content="sembiki.com">
  <meta name="description" content="meemoo.js module for rhythm in bpm or ms" />
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script src="/meemoo/meemoo.js"></script>
</head>
<body>
  
  
  <input id="bpm" type="number" min="0" max="500" value="120" />
  <label for="bpm">bpm</label>
  =
  <input id="ms" type="number" min="120" value="500" />
  <label for="ms">ms</label>
  
  <button type="button" id="start">start</button>
  <button type="button" id="stop">stop</button>
  
  <script type="text/javascript">
  
  $(document).ready(function() {
    
    var meemoo_bpm, meemoo_ms, loopInterval, setBpm, setMs, setLoop, doLoop;
    
    meemoo_bpm = $("#bpm").val();
    meemoo_ms = $("#ms").val();
    
    $("#bpm").change(function(){
      bpm($(this).val());
    });
    
    $("#ms").change(function(){
      ms($(this).val());
    });
    
    $("#start").click(function(){
      Meemoo.inputs.start();
    });
    
    $("#stop").click(function(){
      Meemoo.inputs.stop();
    });
    
    var bpm = function(message){
      meemoo_bpm = parseInt(message, 10);
      meemoo_ms = parseInt((1000 / meemoo_bpm * 60), 10);
      $("#bpm").val(meemoo_bpm);
      $("#ms").val(meemoo_ms);
    };
    
    var ms = function(message){
      meemoo_ms = parseInt(message, 10);
      meemoo_bpm = parseInt((1000 / meemoo_ms * 60), 10);
      $("#ms").val(meemoo_ms);
      $("#bpm").val(meemoo_bpm);
      Meemoo.send("ms", meemoo_ms);
    };
    
    Meemoo.addInputs({
      ms: {
        action: ms,
        port: true,
        type: "int"
      },
      bpm: {
        action: bpm,
        port: true,
        type: "number"
      },
      start: {
        action: function (m) {
          setLoop(meemoo_ms);
        },
        port: true,
        type: "bang"
      },
      stop: {
        action: function (m) {
          clearInterval(loopInterval);
        },
        port: true,
        type: "bang"
      },
      setState: {
        action: function (data) {
          if ( data.bpm ) {
            Meemoo.inputs.bpm(data.bpm);
          }
        }
      }
    });
    
    Meemoo.addOutputs({
      ms: { port: true },
      beat: { port: true }
    });
    
    setLoop = function(val){
      clearInterval(loopInterval);
      loopInterval = setInterval(doLoop, val);
    };
    
    doLoop = function(){
      Meemoo.send("beat");
    };
    
  });
  
  </script>
  
</body>
</html>
