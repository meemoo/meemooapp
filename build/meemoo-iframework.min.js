/*! Meemoo Iframework - v0.2 - 2012-09-28
* http://meemoo.org/
* Copyright (c) 2012 Forrest Oliphant; Licensed MIT, AGPL 
*/
(function(){function A(a,b,c){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual&&w.isFunction(a.isEqual))return a.isEqual(b);if(b.isEqual&&w.isFunction(b.isEqual))return b.isEqual(a);var d=i.call(a);if(d!=i.call(b))return!1;switch(d){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;var e=c.length;while(e--)if(c[e]==a)return!0;c.push(a);var f=0,g=!0;if(d=="[object Array]"){f=a.length,g=f==b.length;if(g)while(f--)if(!(g=f in a==f in b&&A(a[f],b[f],c)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(var h in a)if(w.has(a,h)){f++;if(!(g=w.has(b,h)&&A(a[h],b[h],c)))break}if(g){for(h in b)if(w.has(b,h)&&!(f--))break;g=!f}}return c.pop(),g}var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.slice,h=d.unshift,i=e.toString,j=e.hasOwnProperty,k=d.forEach,l=d.map,m=d.reduce,n=d.reduceRight,o=d.filter,p=d.every,q=d.some,r=d.indexOf,s=d.lastIndexOf,t=Array.isArray,u=Object.keys,v=f.bind,w=function(a){return new I(a)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=w),exports._=w):a._=w,w.VERSION="1.3.3";var x=w.each=w.forEach=function(a,b,d){if(a==null)return;if(k&&a.forEach===k)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(d,a[e],e,a)===c)return}else for(var g in a)if(w.has(a,g)&&b.call(d,a[g],g,a)===c)return};w.map=w.collect=function(a,b,c){var d=[];return a==null?d:l&&a.map===l?a.map(b,c):(x(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),a.length===+a.length&&(d.length=a.length),d)},w.reduce=w.foldl=w.inject=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(m&&a.reduce===m)return d&&(b=w.bind(b,d)),e?a.reduce(b,c):a.reduce(b);x(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},w.reduceRight=w.foldr=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(n&&a.reduceRight===n)return d&&(b=w.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=w.toArray(a).reverse();return d&&!e&&(b=w.bind(b,d)),e?w.reduce(f,b,c,d):w.reduce(f,b)},w.find=w.detect=function(a,b,c){var d;return y(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},w.filter=w.select=function(a,b,c){var d=[];return a==null?d:o&&a.filter===o?a.filter(b,c):(x(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},w.reject=function(a,b,c){var d=[];return a==null?d:(x(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},w.every=w.all=function(a,b,d){var e=!0;return a==null?e:p&&a.every===p?a.every(b,d):(x(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c}),!!e)};var y=w.some=w.any=function(a,b,d){b||(b=w.identity);var e=!1;return a==null?e:q&&a.some===q?a.some(b,d):(x(a,function(a,f,g){if(e||(e=b.call(d,a,f,g)))return c}),!!e)};w.include=w.contains=function(a,b){var c=!1;return a==null?c:r&&a.indexOf===r?a.indexOf(b)!=-1:(c=y(a,function(a){return a===b}),c)},w.invoke=function(a,b){var c=g.call(arguments,2);return w.map(a,function(a){return(w.isFunction(b)?b||a:a[b]).apply(a,c)})},w.pluck=function(a,b){return w.map(a,function(a){return a[b]})},w.max=function(a,b,c){if(!b&&w.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!b&&w.isEmpty(a))return-Infinity;var d={computed:-Infinity};return x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},w.min=function(a,b,c){if(!b&&w.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!b&&w.isEmpty(a))return Infinity;var d={computed:Infinity};return x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},w.shuffle=function(a){var b=[],c;return x(a,function(a,d,e){c=Math.floor(Math.random()*(d+1)),b[d]=b[c],b[c]=a}),b},w.sortBy=function(a,b,c){var d=w.isFunction(b)?b:function(a){return a[b]};return w.pluck(w.map(a,function(a,b,e){return{value:a,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c===void 0?1:d===void 0?-1:c<d?-1:c>d?1:0}),"value")},w.groupBy=function(a,b){var c={},d=w.isFunction(b)?b:function(a){return a[b]};return x(a,function(a,b){var e=d(a,b);(c[e]||(c[e]=[])).push(a)}),c},w.sortedIndex=function(a,b,c){c||(c=w.identity);var d=0,e=a.length;while(d<e){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},w.toArray=function(a){return a?w.isArray(a)?g.call(a):w.isArguments(a)?g.call(a):a.toArray&&w.isFunction(a.toArray)?a.toArray():w.values(a):[]},w.size=function(a){return w.isArray(a)?a.length:w.keys(a).length},w.first=w.head=w.take=function(a,b,c){return b!=null&&!c?g.call(a,0,b):a[0]},w.initial=function(a,b,c){return g.call(a,0,a.length-(b==null||c?1:b))},w.last=function(a,b,c){return b!=null&&!c?g.call(a,Math.max(a.length-b,0)):a[a.length-1]},w.rest=w.tail=function(a,b,c){return g.call(a,b==null||c?1:b)},w.compact=function(a){return w.filter(a,function(a){return!!a})},w.flatten=function(a,b){return w.reduce(a,function(a,c){return w.isArray(c)?a.concat(b?c:w.flatten(c)):(a[a.length]=c,a)},[])},w.without=function(a){return w.difference(a,g.call(arguments,1))},w.uniq=w.unique=function(a,b,c){var d=c?w.map(a,c):a,e=[];return a.length<3&&(b=!0),w.reduce(d,function(c,d,f){if(b?w.last(c)!==d||!c.length:!w.include(c,d))c.push(d),e.push(a[f]);return c},[]),e},w.union=function(){return w.uniq(w.flatten(arguments,!0))},w.intersection=w.intersect=function(a){var b=g.call(arguments,1);return w.filter(w.uniq(a),function(a){return w.every(b,function(b){return w.indexOf(b,a)>=0})})},w.difference=function(a){var b=w.flatten(g.call(arguments,1),!0);return w.filter(a,function(a){return!w.include(b,a)})},w.zip=function(){var a=g.call(arguments),b=w.max(w.pluck(a,"length")),c=new Array(b);for(var d=0;d<b;d++)c[d]=w.pluck(a,""+d);return c},w.indexOf=function(a,b,c){if(a==null)return-1;var d,e;if(c)return d=w.sortedIndex(a,b),a[d]===b?d:-1;if(r&&a.indexOf===r)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1},w.lastIndexOf=function(a,b){if(a==null)return-1;if(s&&a.lastIndexOf===s)return a.lastIndexOf(b);var c=a.length;while(c--)if(c in a&&a[c]===b)return c;return-1},w.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);while(e<d)f[e++]=a,a+=c;return f};var z=function(){};w.bind=function(a,b){var c,d;if(a.bind===v&&v)return v.apply(a,g.call(arguments,1));if(!w.isFunction(a))throw new TypeError;return d=g.call(arguments,2),c=function(){if(this instanceof c){z.prototype=a.prototype;var e=new z,f=a.apply(e,d.concat(g.call(arguments)));return Object(f)===f?f:e}return a.apply(b,d.concat(g.call(arguments)))}},w.bindAll=function(a){var b=g.call(arguments,1);return b.length==0&&(b=w.functions(a)),x(b,function(b){a[b]=w.bind(a[b],a)}),a},w.memoize=function(a,b){var c={};return b||(b=w.identity),function(){var d=b.apply(this,arguments);return w.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},w.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},w.defer=function(a){return w.delay.apply(w,[a,1].concat(g.call(arguments,1)))},w.throttle=function(a,b){var c,d,e,f,g,h,i=w.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var j=function(){e=null,g&&a.apply(c,d),i()};return e||(e=setTimeout(j,b)),f?g=!0:h=a.apply(c,d),i(),f=!0,h}},w.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)};c&&!d&&a.apply(e,f),clearTimeout(d),d=setTimeout(g,b)}},w.once=function(a){var b=!1,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}},w.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments,0));return b.apply(this,c)}},w.compose=function(){var a=arguments;return function(){var b=arguments;for(var c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},w.after=function(a,b){return a<=0?b():function(){if(--a<1)return b.apply(this,arguments)}},w.keys=u||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)w.has(a,c)&&(b[b.length]=c);return b},w.values=function(a){return w.map(a,w.identity)},w.functions=w.methods=function(a){var b=[];for(var c in a)w.isFunction(a[c])&&b.push(c);return b.sort()},w.extend=function(a){return x(g.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a},w.pick=function(a){var b={};return x(w.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])}),b},w.defaults=function(a){return x(g.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])}),a},w.clone=function(a){return w.isObject(a)?w.isArray(a)?a.slice():w.extend({},a):a},w.tap=function(a,b){return b(a),a},w.isEqual=function(a,b){return A(a,b,[])},w.isEmpty=function(a){if(a==null)return!0;if(w.isArray(a)||w.isString(a))return a.length===0;for(var b in a)if(w.has(a,b))return!1;return!0},w.isElement=function(a){return!!a&&a.nodeType==1},w.isArray=t||function(a){return i.call(a)=="[object Array]"},w.isObject=function(a){return a===Object(a)},w.isArguments=function(a){return i.call(a)=="[object Arguments]"},w.isArguments(arguments)||(w.isArguments=function(a){return!!a&&!!w.has(a,"callee")}),w.isFunction=function(a){return i.call(a)=="[object Function]"},w.isString=function(a){return i.call(a)=="[object String]"},w.isNumber=function(a){return i.call(a)=="[object Number]"},w.isFinite=function(a){return w.isNumber(a)&&isFinite(a)},w.isNaN=function(a){return a!==a},w.isBoolean=function(a){return a===!0||a===!1||i.call(a)=="[object Boolean]"},w.isDate=function(a){return i.call(a)=="[object Date]"},w.isRegExp=function(a){return i.call(a)=="[object RegExp]"},w.isNull=function(a){return a===null},w.isUndefined=function(a){return a===void 0},w.has=function(a,b){return j.call(a,b)},w.noConflict=function(){return a._=b,this},w.identity=function(a){return a},w.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},w.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},w.result=function(a,b){if(a==null)return null;var c=a[b];return w.isFunction(c)?c.call(a):c},w.mixin=function(a){x(w.functions(a),function(b){K(b,w[b]=a[b])})};var B=0;w.uniqueId=function(a){var b=B++;return a?a+b:b},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/.^/,D={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var E in D)D[D[E]]=E;var F=/\\|'|\r|\n|\t|\u2028|\u2029/g,G=/\\(\\|'|r|n|t|u2028|u2029)/g,H=function(a){return a.replace(G,function(a,b){return D[b]})};w.template=function(a,b,c){c=w.defaults(c||{},w.templateSettings);var d="__p+='"+a.replace(F,function(a){return"\\"+D[a]}).replace(c.escape||C,function(a,b){return"'+\n_.escape("+H(b)+")+\n'"}).replace(c.interpolate||C,function(a,b){return"'+\n("+H(b)+")+\n'"}).replace(c.evaluate||C,function(a,b){return"';\n"+H(b)+"\n;__p+='"})+"';\n";c.variable||(d="with(obj||{}){\n"+d+"}\n"),d="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+d+"return __p;\n";var e=new Function(c.variable||"obj","_",d);if(b)return e(b,w);var f=function(a){return e.call(this,a,w)};return f.source="function("+(c.variable||"obj")+"){\n"+d+"}",f},w.chain=function(a){return w(a).chain()};var I=function(a){this._wrapped=a};w.prototype=I.prototype;var J=function(a,b){return b?w(a).chain():a},K=function(a,b){I.prototype[a]=function(){var a=g.call(arguments);return h.call(a,this._wrapped),J(b.apply(w,a),this._chain)}};w.mixin(w),x(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];I.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;return(a=="shift"||a=="splice")&&d===0&&delete c[0],J(c,this._chain)}}),x(["concat","join","slice"],function(a){var b=d[a];I.prototype[a]=function(){return J(b.apply(this._wrapped,arguments),this._chain)}}),I.prototype.chain=function(){return this._chain=!0,this},I.prototype.value=function(){return this._wrapped}}).call(this),function(){var a=this,b=a.Backbone,c=Array.prototype.slice,d=Array.prototype.splice,e;typeof exports!="undefined"?e=exports:e=a.Backbone={},e.VERSION="0.9.2";var f=a._;!f&&typeof require!="undefined"&&(f=require("underscore"));var g=a.jQuery||a.Zepto||a.ender;e.setDomLibrary=function(a){g=a},e.noConflict=function(){return a.Backbone=b,this},e.emulateHTTP=!1,e.emulateJSON=!1;var h=/\s+/,i=e.Events={on:function(a,b,c){var d,e,f,g,i;if(!b)return this;a=a.split(h),d=this._callbacks||(this._callbacks={});while(e=a.shift())i=d[e],f=i?i.tail:{},f.next=g={},f.context=c,f.callback=b,d[e]={tail:g,next:i?i.next:f};return this},off:function(a,b,c){var d,e,g,i,j,k;if(!(e=this._callbacks))return;if(!(a||b||c))return delete this._callbacks,this;a=a?a.split(h):f.keys(e);while(d=a.shift()){g=e[d],delete e[d];if(!g||!b&&!c)continue;i=g.tail;while((g=g.next)!==i)j=g.callback,k=g.context,(b&&j!==b||c&&k!==c)&&this.on(d,j,k)}return this},trigger:function(a){var b,d,e,f,g,i,j;if(!(e=this._callbacks))return this;i=e.all,a=a.split(h),j=c.call(arguments,1);while(b=a.shift()){if(d=e[b]){f=d.tail;while((d=d.next)!==f)d.callback.apply(d.context||this,j)}if(d=i){f=d.tail,g=[b].concat(j);while((d=d.next)!==f)d.callback.apply(d.context||this,g)}}return this}};i.bind=i.on,i.unbind=i.off;var j=e.Model=function(a,b){var c;a||(a={}),b&&b.parse&&(a=this.parse(a));if(c=A(this,"defaults"))a=f.extend({},c,a);b&&b.collection&&(this.collection=b.collection),this.attributes={},this._escapedAttributes={},this.cid=f.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(a,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=f.clone(this.attributes),this.initialize.apply(this,arguments)};f.extend(j.prototype,i,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(a){return f.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;var c=this.get(a);return this._escapedAttributes[a]=f.escape(c==null?"":""+c)},has:function(a){return this.get(a)!=null},set:function(a,b,c){var d,e,g;f.isObject(a)||a==null?(d=a,c=b):(d={},d[a]=b),c||(c={});if(!d)return this;d instanceof j&&(d=d.attributes);if(c.unset)for(e in d)d[e]=void 0;if(!this._validate(d,c))return!1;this.idAttribute in d&&(this.id=d[this.idAttribute]);var h=c.changes={},i=this.attributes,k=this._escapedAttributes,l=this._previousAttributes||{};for(e in d){g=d[e];if(!f.isEqual(i[e],g)||c.unset&&f.has(i,e))delete k[e],(c.silent?this._silent:h)[e]=!0;c.unset?delete i[e]:i[e]=g,!f.isEqual(l[e],g)||f.has(i,e)!=f.has(l,e)?(this.changed[e]=g,c.silent||(this._pending[e]=!0)):(delete this.changed[e],delete this._pending[e])}return c.silent||this.change(c),this},unset:function(a,b){return(b||(b={})).unset=!0,this.set(a,null,b)},clear:function(a){return(a||(a={})).unset=!0,this.set(f.clone(this.attributes),a)},fetch:function(a){a=a?f.clone(a):{};var b=this,c=a.success;return a.success=function(d,e,f){if(!b.set(b.parse(d,f),a))return!1;c&&c(b,d)},a.error=e.wrapError(a.error,b,a),(this.sync||e.sync).call(this,"read",this,a)},save:function(a,b,c){var d,g;f.isObject(a)||a==null?(d=a,c=b):(d={},d[a]=b),c=c?f.clone(c):{};if(c.wait){if(!this._validate(d,c))return!1;g=f.clone(this.attributes)}var h=f.extend({},c,{silent:!0});if(d&&!this.set(d,c.wait?h:c))return!1;var i=this,j=c.success;c.success=function(a,b,e){var g=i.parse(a,e);c.wait&&(delete c.wait,g=f.extend(d||{},g));if(!i.set(g,c))return!1;j?j(i,a):i.trigger("sync",i,a,c)},c.error=e.wrapError(c.error,i,c);var k=this.isNew()?"create":"update",l=(this.sync||e.sync).call(this,k,this,c);return c.wait&&this.set(g,h),l},destroy:function(a){a=a?f.clone(a):{};var b=this,c=a.success,d=function(){b.trigger("destroy",b,b.collection,a)};if(this.isNew())return d(),!1;a.success=function(e){a.wait&&d(),c?c(b,e):b.trigger("sync",b,e,a)},a.error=e.wrapError(a.error,b,a);var g=(this.sync||e.sync).call(this,"delete",this,a);return a.wait||d(),g},url:function(){var a=A(this,"urlRoot")||A(this.collection,"url")||B();return this.isNew()?a:a+(a.charAt(a.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(a){a||(a={});var b=this._changing;this._changing=!0;for(var c in this._silent)this._pending[c]=!0;var d=f.extend({},a.changes,this._silent);this._silent={};for(var c in d)this.trigger("change:"+c,this,this.get(c),a);if(b)return this;while(!f.isEmpty(this._pending)){this._pending={},this.trigger("change",this,a);for(var c in this.changed){if(this._pending[c]||this._silent[c])continue;delete this.changed[c]}this._previousAttributes=f.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(a){return arguments.length?f.has(this.changed,a):!f.isEmpty(this.changed)},changedAttributes:function(a){if(!a)return this.hasChanged()?f.clone(this.changed):!1;var b,c=!1,d=this._previousAttributes;for(var e in a){if(f.isEqual(d[e],b=a[e]))continue;(c||(c={}))[e]=b}return c},previous:function(a){return!arguments.length||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return f.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(a,b){if(b.silent||!this.validate)return!0;a=f.extend({},this.attributes,a);var c=this.validate(a,b);return c?(b&&b.error?b.error(this,c,b):this.trigger("error",this,c,b),!1):!0}});var k=e.Collection=function(a,b){b||(b={}),b.model&&(this.model=b.model),b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,{silent:!0,parse:b.parse})};f.extend(k.prototype,i,{model:j,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},add:function(a,b){var c,e,g,h,i,j,k={},l={},m=[];b||(b={}),a=f.isArray(a)?a.slice():[a];for(c=0,g=a.length;c<g;c++){if(!(h=a[c]=this._prepareModel(a[c],b)))throw new Error("Can't add an invalid model to a collection");i=h.cid,j=h.id;if(k[i]||this._byCid[i]||j!=null&&(l[j]||this._byId[j])){m.push(c);continue}k[i]=l[j]=h}c=m.length;while(c--)a.splice(m[c],1);for(c=0,g=a.length;c<g;c++)(h=a[c]).on("all",this._onModelEvent,this),this._byCid[h.cid]=h,h.id!=null&&(this._byId[h.id]=h);this.length+=g,e=b.at!=null?b.at:this.models.length,d.apply(this.models,[e,0].concat(a)),this.comparator&&this.sort({silent:!0});if(b.silent)return this;for(c=0,g=this.models.length;c<g;c++){if(!k[(h=this.models[c]).cid])continue;b.index=c,h.trigger("add",h,this,b)}return this},remove:function(a,b){var c,d,e,g;b||(b={}),a=f.isArray(a)?a.slice():[a];for(c=0,d=a.length;c<d;c++){g=this.getByCid(a[c])||this.get(a[c]);if(!g)continue;delete this._byId[g.id],delete this._byCid[g.cid],e=this.indexOf(g),this.models.splice(e,1),this.length--,b.silent||(b.index=e,g.trigger("remove",g,this,b)),this._removeReference(g)}return this},push:function(a,b){return a=this._prepareModel(a,b),this.add(a,b),a},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return a=this._prepareModel(a,b),this.add(a,f.extend({at:0},b)),a},shift:function(a){var b=this.at(0);return this.remove(b,a),b},get:function(a){return a==null?void 0:this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},where:function(a){return f.isEmpty(a)?[]:this.filter(function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},sort:function(a){a||(a={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var b=f.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(b):this.models.sort(b),a.silent||this.trigger("reset",this,a),this},pluck:function(a){return f.map(this.models,function(b){return b.get(a)})},reset:function(a,b){a||(a=[]),b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c]);return this._reset(),this.add(a,f.extend({silent:!0},b)),b.silent||this.trigger("reset",this,b),this},fetch:function(a){a=a?f.clone(a):{},a.parse===undefined&&(a.parse=!0);var b=this,c=a.success;return a.success=function(d,e,f){b[a.add?"add":"reset"](b.parse(d,f),a),c&&c(b,d)},a.error=e.wrapError(a.error,b,a),(this.sync||e.sync).call(this,"read",this,a)},create:function(a,b){var c=this;b=b?f.clone(b):{},a=this._prepareModel(a,b);if(!a)return!1;b.wait||c.add(a,b);var d=b.success;return b.success=function(e,f,g){b.wait&&c.add(e,b),d?d(e,f):e.trigger("sync",a,f,b)},a.save(null,b),a},parse:function(a,b){return a},chain:function(){return f(this.models).chain()},_reset:function(a){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(a,b){b||(b={});if(a instanceof j)a.collection||(a.collection=this);else{var c=a;b.collection=this,a=new this.model(c,b),a._validate(a.attributes,b)||(a=!1)}return a},_removeReference:function(a){this==a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){if(a!="add"&&a!="remove"||c==this)a=="destroy"&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],this._byId[b.id]=b),this.trigger.apply(this,arguments);else return}});var l=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];f.each(l,function(a){k.prototype[a]=function(){return f[a].apply(f,[this.models].concat(f.toArray(arguments)))}});var m=e.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},n=/:\w+/g,o=/\*\w+/g,p=/[-[\]{}()+?.,\\^$|#\s]/g;f.extend(m.prototype,i,{initialize:function(){},route:function(a,b,c){return e.history||(e.history=new q),f.isRegExp(a)||(a=this._routeToRegExp(a)),c||(c=this[b]),e.history.route(a,f.bind(function(d){var f=this._extractParameters(a,d);c&&c.apply(this,f),this.trigger.apply(this,["route:"+b].concat(f)),e.history.trigger("route",this,b,f)},this)),this},navigate:function(a,b){e.history.navigate(a,b)},_bindRoutes:function(){if(!this.routes)return;var a=[];for(var b in this.routes)a.unshift([b,this.routes[b]]);for(var c=0,d=a.length;c<d;c++)this.route(a[c][0],a[c][1],this[a[c][1]])},_routeToRegExp:function(a){return a=a.replace(p,"\\$&").replace(n,"([^/]+)").replace(o,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});var q=e.History=function(){this.handlers=[],f.bindAll(this,"checkUrl")},r=/^[#\/]/,s=/msie [\w.]+/;q.started=!1,f.extend(q.prototype,i,{interval:50,getHash:function(a){var b=a?a.location:window.location,c=b.href.match(/#(.*)$/);return c?c[1]:""},getFragment:function(a,b){if(a==null)if(this._hasPushState||b){a=window.location.pathname;var c=window.location.search;c&&(a+=c)}else a=this.getHash();return a.indexOf(this.options.root)||(a=a.substr(this.options.root.length)),a.replace(r,"")},start:function(a){if(q.started)throw new Error("Backbone.history has already been started");q.started=!0,this.options=f.extend({},{root:"/"},this.options,a),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var b=this.getFragment(),c=document.documentMode,d=s.exec(navigator.userAgent.toLowerCase())&&(!c||c<=7);d&&(this.iframe=g('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(b)),this._hasPushState?g(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!d?g(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=b;var e=window.location,h=e.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!h)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&h&&e.hash&&(this.fragment=this.getHash().replace(r,""),window.history.replaceState({},document.title,e.protocol+"//"+e.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){g(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),q.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){var b=this.getFragment();b==this.fragment&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe)));if(b==this.fragment)return!1;this.iframe&&this.navigate(b),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a),c=f.any(this.handlers,function(a){if(a.route.test(b))return a.callback(b),!0});return c},navigate:function(a,b){if(!q.started)return!1;if(!b||b===!0)b={trigger:b};var c=(a||"").replace(r,"");if(this.fragment==c)return;this._hasPushState?(c.indexOf(this.options.root)!=0&&(c=this.options.root+c),this.fragment=c,window.history[b.replace?"replaceState":"pushState"]({},document.title,c)):this._wantsHashChange?(this.fragment=c,this._updateHash(window.location,c,b.replace),this.iframe&&c!=this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,c,b.replace))):window.location.assign(this.options.root+a),b.trigger&&this.loadUrl(a)},_updateHash:function(a,b,c){c?a.replace(a.toString().replace(/(javascript:|#).*$/,"")+"#"+b):a.hash=b}});var t=e.View=function(a){this.cid=f.uniqueId("view"),this._configure(a||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},u=/^(\S+)\s*(.*)$/,v=["model","collection","el","id","attributes","className","tagName"];f.extend(t.prototype,i,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(a,b,c){var d=document.createElement(a);return b&&g(d).attr(b),c&&g(d).html(c),d},setElement:function(a,b){return this.$el&&this.undelegateEvents(),this.$el=a instanceof g?a:g(a),this.el=this.$el[0],b!==!1&&this.delegateEvents(),this},delegateEvents:function(a){if(!a&&!(a=A(this,"events")))return;this.undelegateEvents();for(var b in a){var c=a[b];f.isFunction(c)||(c=this[a[b]]);if(!c)throw new Error('Method "'+a[b]+'" does not exist');var d=b.match(u),e=d[1],g=d[2];c=f.bind(c,this),e+=".delegateEvents"+this.cid,g===""?this.$el.bind(e,c):this.$el.delegate(g,e,c)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=f.extend({},this.options,a));for(var b=0,c=v.length;b<c;b++){var d=v[b];a[d]&&(this[d]=a[d])}this.options=a},_ensureElement:function(){if(!this.el){var a=A(this,"attributes")||{};this.id&&(a.id=this.id),this.className&&(a["class"]=this.className),this.setElement(this.make(this.tagName,a),!1)}else this.setElement(this.el,!1)}});var w=function(a,b){var c=z(this,a,b);return c.extend=this.extend,c};j.extend=k.extend=m.extend=t.extend=w;var x={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(a,b,c){var d=x[a];c||(c={});var h={type:d,dataType:"json"};return c.url||(h.url=A(b,"url")||B()),!c.data&&b&&(a=="create"||a=="update")&&(h.contentType="application/json",h.data=JSON.stringify(b.toJSON())),e.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{}),e.emulateHTTP&&(d==="PUT"||d==="DELETE")&&(e.emulateJSON&&(h.data._method=d),h.type="POST",h.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",d)}),h.type!=="GET"&&!e.emulateJSON&&(h.processData=!1),g.ajax(f.extend(h,c))},e.wrapError=function(a,b,c){return function(d,e){e=d===b?e:d,a?a(b,e,c):b.trigger("error",b,e,c)}};var y=function(){},z=function(a,b,c){var d;return b&&b.hasOwnProperty("constructor")?d=b.constructor:d=function(){a.apply(this,arguments)},f.extend(d,a),y.prototype=a.prototype,d.prototype=new y,b&&f.extend(d.prototype,b),c&&f.extend(d,c),d.prototype.constructor=d,d.__super__=a.prototype,d},A=function(a,b){return!a||!a[b]?null:f.isFunction(a[b])?a[b]():a[b]},B=function(){throw new Error('A "url" property or function must be specified')}}.call(this),function(){function c(){return((1+Math.random())*65536|0).toString(16).substring(1)}function d(){return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()}var a=this._,b=this.Backbone;b.LocalStorage=window.Store=function(a){this.name=a;var b=this.localStorage().getItem(this.name);this.records=b&&b.split(",")||[]},a.extend(b.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){return a.id||(a.id=d(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),a},update:function(b){return this.localStorage().setItem(this.name+"-"+b.id,JSON.stringify(b)),a.include(this.records,b.id.toString())||this.records.push(b.id.toString()),this.save(),b},find:function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a.id))},findAll:function(){return a(this.records).chain().map(function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a))},this).compact().value()},destroy:function(b){return this.localStorage().removeItem(this.name+"-"+b.id),this.records=a.reject(this.records,function(a){return a==b.id.toString()}),this.save(),b},localStorage:function(){return localStorage}}),b.LocalStorage.sync=window.Store.sync=b.localSync=function(a,b,c,d){var e=b.localStorage||b.collection.localStorage;typeof c=="function"&&(c={success:c,error:d});var f;switch(a){case"read":f=b.id!=undefined?e.find(b):e.findAll();break;case"create":f=e.create(b);break;case"update":f=e.update(b);break;case"delete":f=e.destroy(b)}f?c.success(f):c.error("Record not found")},b.ajaxSync=b.sync,b.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?b.localSync:b.ajaxSync},b.sync=function(a,c,d,e){return b.getSyncMethod(c).apply(this,[a,c,d,e])}}(),function(){function m(a,b,c){if(a.addEventListener)return a.addEventListener(b,c,!1);a.attachEvent("on"+b,c)}function n(c){return c.type=="keypress"?String.fromCharCode(c.which):a[c.which]?a[c.which]:b[c.which]?b[c.which]:String.fromCharCode(c.which).toLowerCase()}function o(a){var b=a.target||a.srcElement,c=b.tagName;return(" "+b.className+" ").indexOf(" mousetrap ")>-1?!1:c=="INPUT"||c=="SELECT"||c=="TEXTAREA"||b.contentEditable&&b.contentEditable=="true"}function p(a,b){return a.sort().join(",")===b.sort().join(",")}function q(a){a=a||{};var b=!1,c;for(c in h){if(a[c]){b=!0;continue}h[c]=0}b||(k=!1)}function r(a,b,c,d,e){var g,i,j=[],k=c.type;if(!f[a])return[];k=="keyup"&&w(a)&&(b=[a]);for(g=0;g<f[a].length;++g){i=f[a][g];if(i.seq&&h[i.seq]!=i.level)continue;if(k!=i.action)continue;if(k=="keypress"&&!c.metaKey&&!c.ctrlKey||p(b,i.modifiers))d&&i.combo==e&&f[a].splice(g,1),j.push(i)}return j}function s(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function t(a,b){a(b)===!1&&(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),b.returnValue=!1,b.cancelBubble=!0)}function u(a,b){if(o(b))return;var c=r(a,s(b),b),d,e={},f=!1;for(d=0;d<c.length;++d){if(c[d].seq){f=!0,e[c[d].seq]=1,t(c[d].callback,b);continue}!f&&!k&&t(c[d].callback,b)}b.type==k&&!w(a)&&q(e)}function v(a){a.which=typeof a.which=="number"?a.which:a.keyCode;var b=n(a);if(!b)return;if(a.type=="keyup"&&j==b){j=!1;return}u(b,a)}function w(a){return a=="shift"||a=="ctrl"||a=="alt"||a=="meta"}function x(){clearTimeout(i),i=setTimeout(q,1e3)}function y(){if(!e){e={};for(var b in a){if(b>95&&b<112)continue;a.hasOwnProperty(b)&&(e[a[b]]=b)}}return e}function z(a,b,c){return c||(c=y()[a]?"keydown":"keypress"),c=="keypress"&&b.length&&(c="keydown"),c}function A(a,b,c,d){h[a]=0,d||(d=z(b[0],[]));var e=function(b){k=d,++h[a],x()},f=function(a){t(c,a),d!=="keyup"&&(j=n(a)),setTimeout(q,10)},g;for(g=0;g<b.length;++g)B(b[g],g<b.length-1?e:f,d,a,g)}function B(a,b,e,g,h){a=a.replace(/\s+/g," ");var i=a.split(" "),j,k,l,m=[];if(i.length>1)return A(a,i,b,e);l=a==="+"?["+"]:a.split("+");for(j=0;j<l.length;++j)k=l[j],d[k]&&(k=d[k]),e&&e!="keypress"&&c[k]&&(k=c[k],m.push("shift")),w(k)&&m.push(k);e=z(k,m,e),f[k]||(f[k]=[]),r(k,m,{type:e},!g,a),f[k][g?"unshift":"push"]({callback:b,modifiers:m,action:e,seq:g,level:h,combo:a})}function C(a,b,c){for(var d=0;d<a.length;++d)B(a[d],b,c)}var a={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},b={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},c={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},d={option:"alt",command:"meta","return":"enter",escape:"esc"},e,f={},g={},h={},i,j=!1,k=!1;for(var l=1;l<20;++l)a[111+l]="f"+l;for(l=0;l<=9;++l)a[l+96]=l;m(document,"keypress",v),m(document,"keydown",v),m(document,"keyup",v);var D={bind:function(a,b,c){return C(a instanceof Array?a:[a],b,c),g[a+":"+c]=b,this},unbind:function(a,b){return g[a+":"+b]&&(delete g[a+":"+b],this.bind(a,function(){},b)),this},trigger:function(a,b){return g[a+":"+b](),this},reset:function(){return f={},g={},this}};window.Mousetrap=D,typeof define=="function"&&define.amd&&define("mousetrap",function(){return D})}(),function(a){function e(a,b){if(a.originalEvent.touches.length>1)return;a.preventDefault();var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}a.support.touch="ontouchend"in document;if(!a.support.touch)return;var b=a.ui.mouse.prototype,c=b._mouseInit,d;b._touchStart=function(a){var b=this;if(d||!b._mouseCapture(a.originalEvent.changedTouches[0]))return;d=!0,b._touchMoved=!1,e(a,"mouseover"),e(a,"mousemove"),e(a,"mousedown")},b._touchMove=function(a){if(!d)return;this._touchMoved=!0,e(a,"mousemove")},b._touchEnd=function(a){if(!d)return;e(a,"mouseup"),e(a,"mouseout"),this._touchMoved||e(a,"click"),d=!1},b._mouseInit=function(){var b=this;b.element.bind("touchstart",a.proxy(b,"_touchStart")).bind("touchmove",a.proxy(b,"_touchMove")).bind("touchend",a.proxy(b,"_touchEnd")),c.call(b)}}(jQuery),$(function(){var a='<div class="showpanel"><button class="button showload">app</button><button class="button showsource">source</button><button class="button showlibrary">module</button></div><div class="panel"><div class="choosepanel"><button class="button showload">app</button><button class="button showsource">source</button><button class="button showlibrary">module</button><button class="button close">close</button></div><div class="load"><div class="controls"><form class="loadfromgist"><input class="loadfromgistinput" name="loadfromgistinput" placeholder="load app from gist url" type="text" /><button class="loadfromgistsubmit" type="submit">load</button></form></div><div class="listing"><button class="button newblank" title="new blank app">new</button><div class="currentapp"></div><div class="localapps"><h1>Saved Apps</h1></div><div class="examples"><h1>Examples</h1></div></div></div><div class="source"><div class="sourceedit"><textarea /></div><div class="controls"><button class="button sourcerefresh" title="refresh the source code">refresh</button><button class="button sourcecompress" title="refresh and compress the source code into one line">compress</button><button class="button sourceapply" title="reloads the app">apply changes</button></div></div><div class="library"><div class="controls"><form class="addbyurl"><input class="addbyurlinput" name="addbyurlinput" placeholder="search or url" type="text" /><button class="addbyurlsubmit" type="submit">load</button></form></div><div class="listing"></div></div></div>',b='<h1>Current App</h1><div class="info"><h2 title="url, click to edit" class="seturl editable"></h2><p title="title, click to edit" class="settitle editable"></p><p title="description, click to edit" class="setdescription editable"></p></div><div class="savecontrols"><button class="savelocal">save local</button><button class="forklocal" title="save as... copy app and save under a new name">fork</button><button class="savegist" title="save app to gist.github.com anonymously">save public</button><button class="deletelocal">delete</button></div><div class="permalink" title="last publicly saved version"></div>',c=Backbone.View.extend({tagName:"div",className:"app",template:_.template(a),currentTemplate:_.template(b),frameCount:0,NativeNodes:{},events:{"click .close":"closePanels","click .showload":"showLoad","click .showsource":"showSource","click .showlibrary":"showLibrary","click .sourcerefresh":"sourceRefresh","click .sourcecompress":"sourceCompress","click .sourceapply":"sourceApply","submit .addbyurl":"addByUrl","submit .loadfromgist":"loadFromGist","click .savelocal":"saveLocal","click .forklocal":"forkLocal","click .savegist":"saveGist","click .deletelocal":"deleteLocal","click .newblank":"newBlank","blur .settitle":"setTitle","blur .setdescription":"setDescription","blur .seturl":"setUrl"},initialize:function(){this.render(),$("body").prepend(this.el),this.closePanels(),this.$(".close").button({icons:{primary:"icon-cancel"},text:!1}),this.$(".showsource").button({icons:{primary:"icon-cog"}}),this.$(".showload").button({icons:{primary:"icon-folder-open"}}),this.$(".showlibrary").button({icons:{primary:"icon-plus"}}),this.$(".sourcerefresh").button({icons:{primary:"icon-cw"}}),this.$(".sourcecompress").button({icons:{primary:"icon-bag"}}),this.$(".sourceapply").button({icons:{primary:"icon-ok"}}),this.$(".addbyurlsubmit").button({icons:{primary:"icon-ok"}}),this.$(".loadfromgistsubmit").button({icons:{primary:"icon-ok"}}),this.$(".newblank").button({icons:{primary:"icon-doc"}})},allLoaded:function(){this.loadLocalApps()},render:function(){return this.$el.html(this.template()),this},shownGraph:null,wireColors:["#FF9292","#00C2EE","#DCA761","#8BB0FF","#96BD6D","#E797D7","#29C6AD"],wireColorIndex:0,selectedPort:null,getWireColor:function(){var a=this.wireColors[this.wireColorIndex];return this.wireColorIndex++,this.wireColorIndex>this.wireColors.length-1&&(this.wireColorIndex=0),a},loadGraph:function(a){this.shownGraph&&(this.shownGraph.remove(),this.shownGraph=null),this.wireColorIndex=0,this.shownGraph=new Iframework.Graph(a),a.info.title&&(document.title="Meemoo: "+a.info.title),this.updateCurrentInfo()},gotMessage:function(a){if(Iframework.shownGraph){var b=Iframework.shownGraph.get("nodes").get(a.data.nodeid);if(b)for(var c in a.data)if(a.data.hasOwnProperty(c)){var d=a.data[c];switch(c){case"message":b.sendFromFrame(d);break;case"info":b.infoLoaded(d);break;case"addInput":b.addInput(d);break;case"addOutput":b.addOutput(d);break;case"stateReady":b.iframeLoaded();break;case"set":b.setValue(d);break;default:}}}},Library:null,loadLibrary:function(a){this.Library=new Iframework.Modules;var b=[],c=$("<div></div>");for(var d in a){if(!a.hasOwnProperty(d))continue;var e=$('<div class="library-section"></div>');e.append($('<h3><a href="#">'+d+"</a></h3>"));var f=$("<div></div>"),g=a[d];for(var h=0;h<g.length;h++){var i=new Iframework.Module(g[h]);this.Library.add(i),i.initializeView(),f.append(i.view.$el);var j={value:i.get("src"),label:i.get("info").title+" by "+i.get("info").author+" - "+i.get("info").description+" "+i.get("src"),title:i.get("info").title,desc:i.get("info").description};b.push(j)}e.append(f),c.append(e)}this.$(".panel .library .listing").append(c),c.children(".library-section").accordion({animated:!1,header:"h3",autoHeight:!1,collapsible:!0,create:function(a){$(a.target).accordion("activate",!1)}}),this.$(".addbyurlinput").autocomplete({minLength:1,source:b}).data("autocomplete")._renderItem=function(a,b){return $("<li></li>").data("item.autocomplete",b).append('<a title="'+b.value+'"><span class="autocomplete-title">'+b.title+'</span><br /><span class="autocomplete-desc">'+b.desc+"</span></a>").appendTo(a)}},_exampleGraphs:[],_loadedExample:null,loadExampleApps:function(a){this._exampleGraphs=this._exampleGraphs.concat(a);var b="";for(var c=0;c<a.length;c++){var d=a[c].info.url;d&&(b+='<a href="#example/'+d+'" title="'+a[c].info.title+": "+a[c].info.description+'">'+d+"</a> <br />")}this.$(".panel .load .examples").append(b),this.shownGraph||(this._loadedExample?this.loadExample(this._loadedExample):!this._loadedLocal&&!this._loadedLocal&&!this._loadedGist&&Iframework.loadGraph(this._exampleGraphs[0]))},loadExample:function(a){this._loadedExample=a;for(var b=0;b<this._exampleGraphs.length;b++)if(this._exampleGraphs[b].info.url===a)return this._loadedLocalApp=null,this.loadGraph(this._exampleGraphs[b]),this.analyze("load","example",a),!0},closePanels:function(){this.$(".showpanel").show(),this.$(".panel").hide(),this.$(".graph").css("right","0px"),this.$(".panel .load").hide(),this.$(".panel .library").hide(),this.$(".panel .source").hide()},showpanel:function(){this.$(".panel .load").hide(),this.$(".panel .library").hide(),this.$(".panel .source").hide(),this.$(".showpanel").hide(),this.$(".panel").show(),this.$(".graph").css("right","350px")},showLoad:function(){this.showpanel(),this.$(".panel .load").show()},showSource:function(){this.showpanel(),this.$(".panel .source").show(),this.sourceRefresh()},showLibrary:function(){this.showpanel(),this.$(".panel .library").show()},sourceRefresh:function(){this.$(".panel .source textarea").val(JSON.stringify(Iframework.shownGraph,null,"  "))},sourceCompress:function(){this.$(".panel .source textarea").val(JSON.stringify(Iframework.shownGraph,null,""))},sourceApply:function(){try{var a=JSON.parse($(".panel .sourceedit textarea").val());this.loadGraph(a),this.showSource()}catch(b){console.warn("json parse error: "+b)}},addByUrl:function(){$(".addbyurlinput").blur();var a=this.$(".addbyurlinput").val();if(a!==""){var b=this.$(".graph");this.shownGraph.addNode({src:a,x:b.scrollLeft()+b.width()/2-100,y:b.scrollTop()+b.height()/2-100}),this.$(".addbyurlinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".addbyurlinput").attr("placeholder","search or url")},1e3)}return!1},loadFromGist:function(){var a=this.loadFromGistId(this.$(".loadfromgistinput").val());return a&&($(".loadfromgistinput").blur(),this.router&&this.router.navigate("gist/"+a),this.$(".loadfromgistinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".loadfromgistinput").attr("placeholder","load app from gist url")},1500)),!1},loadFromGistId:function(a){this._loadedGist=a;var b=a.split("/");return b.length>3&&b[2]==="gist.github.com"&&(a=b[3]),$.ajax({url:"https://api.github.com/gists/"+a,type:"GET",dataType:"jsonp"}).success(function(a){var b=[];for(var c in a.data.files)if(a.data.files.hasOwnProperty(c)){var d=JSON.parse(a.data.files[c].content);if(d){var e=a.data.html_url;if(!d.info.parents||!d.info.parents.push)d.info.parents=[];d.info.parents.indexOf(e)===-1&&d.info.parents.push(e),b.push(d)}}b.length>0&&(this._loadedLocalApp=null,Iframework.loadGraph(b[0]),Iframework.closePanels())}).error(function(a){console.warn("gist load error",a)}),this.analyze("load","gist",a),a},saveGist:function(){var a=this.shownGraph.toJSON(),b={description:"meemoo app: "+a.info.title,"public":!0};b.files={};var c=a.info.url+".json";b.files[c]={content:JSON.stringify(a,null,"  ")},this.$(".savegist").button({disabled:!0,label:"saving..."}),$.ajax({url:"https://api.github.com/gists",type:"POST",dataType:"json",data:JSON.stringify(b)}).success(function(b){var c=Iframework.shownGraph.get("info");if(!c.hasOwnProperty("parents")||!c.parents.push)a.info.parents=[];a.info.parents.push(b.html_url),Iframework.saveLocal(),Iframework.updateCurrentInfo(),Iframework.analyze("save","gist",b.id)}).error(function(a){var b="meemoo app: "+Iframework.shownGraph.toJSON().info.title;Iframework.$(".permalink").html('api is down (;_;) copy your app source code to <a href="https://gist.github.com/?description='+encodeURIComponent(b)+'" target="_blank">gist.github.com</a>'),console.warn("gist save error",a)}).complete(function(a){this.$(".savegist").button({disabled:!1,label:"save public"})})},loadLocalApps:function(){this._localApps=new Iframework.LocalApps,this._localApps.fetch({success:function(a){Iframework._localApps.each(function(a){a.initializeView()}),Iframework.shownGraph||Iframework._loadedLocal&&Iframework.loadLocal(Iframework._loadedLocal)},error:function(a){console.warn("error loading local apps")}})},_loadedLocal:null,_loadedLocalApp:null,loadLocal:function(a){this._loadedLocal=a;if(this._localApps){var b=this._localApps.getByUrl(a);return b?(b.load(),!0):(console.warn("Didn't find local app with matching url."),this.newBlank(),!1)}return!1},setKey:function(a){var b=window.prompt("Enter a url key",a);return b&&(b=this.encodeKey(b),this.shownGraph.setInfo("url",b)),b},encodeKey:function(a){return a=a.toLowerCase().replace(/ /g,"-"),a=encodeURIComponent(a),a},saveLocal:function(){this.shownGraph.get("info")||this.shownGraph.set({info:{}});while(!this.shownGraph.get("info").hasOwnProperty("url")||this.shownGraph.get("info").url===""){var a;this.shownGraph.get("info").hasOwnProperty("title")&&this.shownGraph.get("info").title!==""?a=this.shownGraph.get("info").title:a="app-"+(new Date).getTime();if(!this.setKey(a))return!1}var b=JSON.parse(JSON.stringify(this.shownGraph)),c=b.info.url,d;if(this._loadedLocalApp)if(this._localApps.getByUrl(c)&&this._localApps.getByUrl(c)!==this._loadedLocalApp)if(window.confirm('"'+c+'" already exists as a local app. Do you want to replace it?'))d=this._localApps.updateOrCreate(b);else return!1;else d=this._loadedLocalApp,d.save({graph:b}),d.trigger("change");else{if(this._localApps.getByUrl(c)&&!window.confirm('"'+c+'" already exists as a local app. Do you want to replace it?'))return!1;d=this._localApps.updateOrCreate(b)}return this._loadedLocalApp=d,this.analyze("save","local","x"),this.updateCurrentInfo(),Iframework.router.navigate("local/"+c),d},forkLocal:function(){this._loadedLocalApp=null;var a=this.shownGraph.get("info").url+"-copy";this.setKey(a),this.saveLocal()},deleteLocal:function(){this._loadedLocalApp&&(this._loadedLocalApp.destroy(),this._loadedLocalApp=null)},setTitle:function(){var a=this.$(".currentapp .info .settitle").text();a!==this.shownGraph.get("info").title&&this.shownGraph.setInfo("title",a)},setDescription:function(){var a=this.$(".currentapp .info .setdescription").text();a!==this.shownGraph.get("info").description&&this.shownGraph.setInfo("description",a)},setUrl:function(){var a=this.$(".currentapp .info .seturl").text();a=this.encodeKey(a),a!==this.shownGraph.get("info").url&&this.shownGraph.setInfo("url",a)},updateCurrentInfo:function(){var a=this.shownGraph.toJSON();this.$(".currentapp").html(this.currentTemplate(a)),this.$(".currentapp .savelocal").button({icons:{primary:"icon-install"}}),this.$(".currentapp .forklocal").button({icons:{primary:"icon-split"}}),this.$(".currentapp .savegist").button({icons:{primary:"icon-globe-1"}}),this.$(".currentapp .deletelocal").button({icons:{primary:"icon-trash"},text:!1}),this.$(".currentapp .seturl").text(decodeURIComponent(a.info.url)),this.$(".currentapp .settitle").text(a.info.title),this.$(".currentapp .setdescription").text(a.info.description),this.$(".editable").attr("contenteditable","true");if(a.info.hasOwnProperty("parents")){var b=a.info.parents;if(b.length>0){var c=b[b.length-1],d=c.split("/");if(d.length>0){var e=d[d.length-1],f="http://meemoo.org/iframework/#gist/"+e,g=encodeURIComponent(f),h=encodeURIComponent(a.info.title),i=$("<span />").text(f).click(function(a){var b;if(document.body.createTextRange)b=document.body.createTextRange(),b.moveToElementText(a.target),b.select();else if(window.getSelection){var c=window.getSelection();b=document.createRange(),b.selectNodeContents(a.target),c.removeAllRanges(),c.addRange(b)}}),j=$('<a title="your saved gist" target="_blank" class="share icon-github"></a>').attr("href",c),k=$('<a title="share on facebook" target="_blank" class="share icon-facebook-rect"></a>').attr("href","https://www.facebook.com/sharer.php?u="+g+"&t="+h),l=f+" "+a.info.title+" #meemoo "+a.info.description;l.length>=158&&(l=l.substr(0,155)+"...");var m=$('<a title="post to twitter" target="_blank" class="share icon-twitter-bird"></a>').attr("href","https://twitter.com/intent/tweet?text="+encodeURIComponent(l));this.$(".currentapp .permalink").empty().append(i).append(" ").append(j).append(" ").append(k).append(m)}}}this._loadedLocalApp?this.$(".currentapp .deletelocal").show():this.$(".currentapp .deletelocal").hide()},newBlank:function(){this.loadGraph({info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]}),this._loadedLocalApp=null,this.showLibrary(),Iframework.router.navigate("new")},analyze:function(a,b,c){}});window.Iframework=new c,window.addEventListener("message",Iframework.gotMessage,!1)}),$(function(){Iframework.util={types:{"undefined":"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error","[object HTMLCanvasElement]":"HTMLCanvasElement","[object ImageData]":"ImageData"},type:function(a){return this.types[typeof a]||this.types[Object.prototype.toString.call(a)]||(a?"object":"null")},imageTypes:["png","gif","jpg","jpeg","webp"],isImageURL:function(a){var b=a.split(".");if(b.length>1){var c=b[b.length-1];return this.imageTypes.indexOf(c)>-1}return!1}},window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()}),$(function(){Iframework.Event=Backbone.Model.extend({defaults:function(){return{action:"",args:{}}},initialize:function(){}}),Iframework.EventsHistory=Backbone.Collection.extend({model:Iframework.Event}),Mousetrap.bind(["command+z","ctrl+z"],function(a){var b=window.Iframework.shownGraph,c=b.eventsHistory.last();if(c.get("action")==="removeNode"){var d=c.get("args").node,e=b.usedIds.indexOf(d.get("id"));b.usedIds.splice(e,1),b.addNode(d);var f;for(f=0;f<d.Inputs.length;f++)d.view.addInput(d.Inputs.at(f));for(f=0;f<d.Outputs.length;f++)d.view.addOutput(d.Outputs.at(f));var g=c.get("args").edges;for(f=0;f<g.length;f++)b.addEdge(g[f])}b.eventsHistory.pop()})}),$(function(){Iframework.LocalApp=Backbone.Model.extend({initializeView:function(){return this.view||(this.view=new Iframework.LocalAppView({model:this})),this.view},load:function(){Iframework._loadedLocalApp=this;var a=JSON.parse(JSON.stringify(this.get("graph")));Iframework.loadGraph(a)}}),Iframework.LocalApps=Backbone.Collection.extend({model:Iframework.LocalApp,localStorage:new Backbone.LocalStorage("LocalApps"),getByUrl:function(a){var b=this.find(function(b){return b.get("graph").info.url===a});return b},updateOrCreate:function(a){var b;return b=this.find(function(b){return b.get("graph").info.url===a.info.url}),b?(b.save({graph:a}),b.trigger("change")):(b=this.create({graph:a}),b.initializeView()),b}})}),$(function(){var a='<a class="url" href="#local/<%= graph.info.url %>"></a><div class="info"><h2 class="title"><%= graph.info.title %></h2><p class="description"><%= graph.info.description %></p></div>';Iframework.LocalAppView=Backbone.View.extend({tagName:"div",className:"localapp",template:_.template(a),events:{},initialize:function(){return this.render(),Iframework.$(".localapps").append(this.el),this.model.on("change",this.update,this),this.model.on("destroy",this.remove,this),this},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".url").text(decodeURIComponent(this.model.get("graph").info.url)),this.$(".info").hide()},update:function(){this.render(),Iframework.updateCurrentInfo()},remove:function(){this.$el.remove()}})}),$(function(){Iframework.Graph=Backbone.Model.extend({loaded:!1,defaults:{info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]},usedIds:[],edgeCount:0,eventsHistory:[],initialize:function(){this.usedIds=[];if(this.attributes.nodes){var a=this.attributes.nodes;this.attributes.nodes=new Iframework.Nodes;for(var b=0;b<a.length;b++){var c=this.makeNode(a[b]);c&&this.addNode(c)}}if(this.attributes.edges){var d=this.attributes.edges;this.attributes.edges=new Iframework.Edges;for(var e=0;e<d.length;e++){var f=new Iframework.Edge(d[e]);f.graph=this,this.addEdge(f)}}this.eventsHistory=new Iframework.EventsHistory,_.defer(function(){Iframework.shownGraph.testLoaded()}),this.on("change",this.graphChanged)},testLoaded:function(){var a=!0;return this.get("nodes").each(function(b){b.hasOwnProperty("lazyLoadType")&&(Iframework.NativeNodes.hasOwnProperty(b.lazyLoadType)?b.view&&!b.Native&&b.view.initializeNative():a=!1)},this),a&&this.initializeView(),a},initializeView:function(){this.view||(this.view=new Iframework.GraphView({model:this}))},setInfo:function(a,b){var c=this.get("info");c[a]=b,this.trigger("change")},makeNode:function(a){if(!a.src)return!1;var b;if(Iframework.util.isImageURL(a.src)){var c=a.src;a.src="meemoo:file/image",a.state||(a.state={}),a.state.url=c}var d=a.src.split(":");if(d.length<2)return!1;if(d[0]==="meemoo"){var e=d[d.length-1],f=e.split("/");e=f.join("-"),f[0]&&f[1]&&yepnope([{test:Iframework.NativeNodes.hasOwnProperty(f[0]),nope:"src/nodes/"+f[0]+".js"},{test:Iframework.NativeNodes.hasOwnProperty(f[0]+"-"+f[1]),nope:"src/nodes/"+f[0]+"-"+f[1]+".js",complete:function(){_.defer(function(){Iframework.shownGraph.testLoaded()})}}]),b=new Iframework.NodeBox(a),b.lazyLoadType=e}else b=new Iframework.NodeBoxIframe(a);return b},addNode:function(a){if(!a.cid){a=this.makeNode(a);if(!a)return!1}a.graph=this;var b=this.get("nodes").length,c=parseInt(a.get("id"),10);c!==c&&a.set({id:b});while(this.usedIds.indexOf(a.get("id"))>=0)b++,a.set({id:b});this.usedIds.push(a.get("id"));var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(var f=0;f<5;f++)e+=d.charAt(Math.floor(Math.random()*d.length));return a.frameIndex="frame_"+a.get("id")+"_"+Iframework.frameCount++ +e+"_through",this.get("nodes").add(a),this.view&&this.view.addNode(a),this.trigger("change"),a},addEdge:function(a){var b=this.get("edges").any(function(b){return b.get("source")[0]===a.get("source")[0]&&b.get("source")[1]===a.get("source")[1]&&b.get("target")[0]===a.get("target")[0]&&b.get("target")[1]===a.get("target")[1]});return b?(console.warn("duplicate edge ignored",a),!1):(this.trigger("change"),this.get("edges").add(a))},remove:function(){this.get("nodes").each(function(a){a.remove(!1)}),this.view&&this.view.remove()},removeNode:function(a){var b=[];_.each(a.view.relatedEdges(),function(a){b.push(a),a.remove()},this),this.view&&this.view.removeNode(a),this.get("nodes").remove(a),this.eventsHistory.add(new Iframework.Event({action:"removeNode",args:{node:a,edges:b}})),this.trigger("change")},removeEdge:function(a){a.disconnect(),this.get("edges").remove(a),this.view&&this.view.removeEdge(a),this.trigger("change")},checkLoaded:function(){for(var a=0;a<this.get("nodes").length;a++)if(this.get("nodes").at(a).loaded===!1)return!1;this.loaded=!0;var b=this;return setTimeout(function(){b.connectEdges()},500),!0},reconnectEdges:function(){for(var a=0;a<this.get("edges").length;a++)this.get("edges").at(a).disconnect();setTimeout(function(){Iframework.shownGraph.connectEdges()},500)},connectEdges:function(){this.get("edges").each(function(a){a.connected||a.connect()}),this.get("nodes").each(function(a){a.setState()})},graphChanged:function(){Iframework.$(".source").is(":visible")&&window.setTimeout(function(){Iframework.sourceRefresh()},100)}}),Iframework.Graphs=Backbone.Collection.extend({model:Iframework.Graph})}),$(function(){var a='<div class="edges"><svg id="edgesSvg" class="edgesSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg></div><div class="nodes" />';Iframework.GraphView=Backbone.View.extend({tagName:"div",className:"graph",template:_.template(a),events:{click:"click",drop:"drop",selectablestart:"selectableStart",selectablestop:"selectableStop"},initialize:function(){this.render(),Iframework.$el.prepend(this.el),Iframework.$(".panel").is(":visible")&&this.$el.css("right","350px"),this.model.get("nodes").each(this.addNode),this.$el.droppable({accept:".addnode"}).selectable({filter:".module",delay:20}),this.resizeEdgeSVG(),window.requestAnimationFrame(this.renderAnimationFrame)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderAnimationFrame:function(a){a=a!==undefined?a:Date.now();var b=Iframework.shownGraph.view;!b||(window.requestAnimationFrame(b.renderAnimationFrame),b.model.get("nodes").each(function(b){b.view.Native&&b.view.Native.renderAnimationFrame(a)}))},click:function(a){$(".edge-edit").remove(),Iframework.selectedPort=null,$("div.module").removeClass("active")},drop:function(a,b){var c=b.draggable.data("module"),d=Math.round(this.$el.scrollLeft()+b.offset.left+10),e=Math.round(this.$el.scrollTop()+b.offset.top+35);c.view.dragAddNode({x:d,y:e})},addNode:function(a){this.$(".nodes").append(a.initializeView().el),!a.lazyLoadType||a.view.initializeNative()},addEdge:function(a){a.initializeView(),!a.Source.view||a.Source.view.resetRelatedEdges(),!a.Target.view||a.Target.view.resetRelatedEdges()},remove:function(){this.$el.remove()},removeNode:function(a){a.view&&a.view.remove()},removeEdge:function(a){a.Source&&a.Source.view&&a.Source.view.resetRelatedEdges(),a.Target&&a.Target.view&&a.Target.view.resetRelatedEdges(),a.view&&a.view.remove()},resizeEdgeSVG:function(){var a=0,b=0;this.model.get("nodes").each(function(c){var d=c.get("x")+c.get("w");d>a&&(a=d);var e=c.get("y")+c.get("h");e>b&&(b=e)},this),a+=150,b+=50,a===150&&b===50&&(a=this.$el.width(),b=this.$el.height()),this.$("#edgesSvg").css({width:a,height:b})},selectableStart:function(){this.maskFrames()},_selected:[],selectableStop:function(a){a&&this.unmaskFrames(),this._selected=[];var b=$(".module.ui-selected");for(var c=0;c<b.length;c++)this._selected.push({el:b[c],offset:$(b[c]).offset(),view:$(b[c]).data("view")})},selectAll:function(){$(".module").addClass("ui-selected"),this.selectableStop()},selectNone:function(){$(".module").removeClass("ui-selected"),this.selectableStop()},cut:function(){this.copy();var a;for(a=0;a<Iframework._copied.nodes.length;a++)Iframework._copied.nodes[a].x-=50,Iframework._copied.nodes[a].y-=50;for(a=0;a<this._selected.length;a++)this._selected[a].view.removeModel();this.selectableStop()},copy:function(){var a={nodes:[],edges:[]};for(var b=0;b<this._selected.length;b++)a.nodes.push(this._selected[b].view.model.toJSON());this.model.get("edges").each(function(c){var d,e=!1;for(b=0;b<this._selected.length;b++)c.Source.node===this._selected[b].view.model&&(d=!0),c.Target.node===this._selected[b].view.model&&(e=!0);d&&e&&a.edges.push(c.toJSON())},this),Iframework._copied=a},paste:function(){var a=Iframework._copied;if(a&&a.nodes.length>0){var b=[];$(".module").removeClass("ui-selected");for(var c=0;c<a.nodes.length;c++){var d=a.nodes[c];d.x+=50,d.y+=50;var e=this.model.addNode(d);e.copiedFrom=d.id,b.push(e),e.view&&e.view.select()}this.selectableStop();for(var f=0;f<a.edges.length;f++){var g=a.edges[f],h={source:[],target:[]};for(var i=0;i<b.length;i++){var j=b[i];g.source[0]===j.copiedFrom&&(h.source[0]=j.id),g.target[0]===j.copiedFrom&&(h.target[0]=j.id)}h.source[1]=g.source[1],h.target[1]=g.target[1],h=new Iframework.Edge(h),h.graph=this.model,this.model.addEdge(h)}}},maskFrames:function(){$(".iframe-type").append('<div class="iframemask" />')},unmaskFrames:function(){$(".iframemask").remove()}})}),$(function(){Iframework.Node=Backbone.Model.extend({send:function(a){},receive:function(a){},sendFromFrame:function(){},iframeLoaded:function(){}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeView=Backbone.View.extend({send:function(a){this.model.send(a)},receive:function(a){this.model.receive(a)}})}),$(function(){Iframework.NodeBox=Iframework.Node.extend({loaded:!1,defaults:function(){return{src:"",x:100,y:400,z:0,w:200,h:210,state:{}}},info:{title:"native-node",description:"extend me"},initialize:function(){this.Inputs=new Iframework.PortsIn,this.Outputs=new Iframework.PortsOut,this.on("change",this.nodeChanged)},initializeView:function(){return this.view=new Iframework.NodeBoxView({model:this}),this.view},send:function(a,b){var c=this.Outputs.get(a);!c||c.send(b)},receive:function(a){for(var b in a)this.view.Native&&(this.view.Native["input"+b]?this.view.Native["input"+b](a[b]):(this.view.Native["_"+b]=a[b],this.view.Native._triggerRedraw=!0))},infoLoaded:function(a){this.info=a,this.view&&this.view.infoLoaded(a)},setState:function(){var a=this.get("state");if(a&&this.view.Native)for(var b in a)this.view.Native["input"+b]?this.view.Native["input"+b](a[b]):this.view.Native["_"+b]=a[b]},addInput:function(a){a.id=a.name;var b=this.Inputs.get(a.name);if(b){b.set(a);return}var c;a.type==="image"?c=new Iframework.PortInImage(a):c=new Iframework.PortIn(a),c.isIn=!0,c.node=this,c.graph=this.graph,this.Inputs.add(c),this.view&&this.view.addInput(c);var d=this.get("state");a.hasOwnProperty("default")&&a["default"]!==""&&!d.hasOwnProperty(a.name)&&(d[a.name]=a["default"])},addOutput:function(a){a.id=a.name;var b=this.Outputs.get(a.name);if(b){b.set(a);return}var c;a.type==="image"?c=new Iframework.PortOutImage(a):c=new Iframework.PortOut(a),c.isIn=!1,c.node=this,c.graph=this.graph,this.Outputs.add(c),this.view&&this.view.addOutput(c)},nodeChanged:function(){this.graph&&this.graph.trigger("change")},remove:function(a){a?this.graph.removeNode(this):this.view&&this.view.remove()},setValue:function(a){for(var b in a)this.get("state")[b]=a[b];this.nodeChanged()},toString:function(){return this.info?"Native node "+this.get("id")+": "+this.info.title:"Native node "+this.get("id")}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var a='<div class="module" style="left:<%= get("x")-10 %>px;top:<%= get("y")-30 %>px;width:<%= get("w")+20 %>px;height:<%= get("h")+40 %>px;" ><div class="outer"></div><div class="ports ports-in"></div><div class="ports ports-out"></div><h1 class="title">...</h1><button type="button" class="showcontrols">show controls</button><div class="controls"><button type="button" class="remove">remove</button><button type="button" class="hidecontrols">hide controls</button></div><div class="inner"></div></div>';Iframework.NodeBoxView=Iframework.NodeView.extend({tagName:"div",className:"node",template:_.template(a),events:{"dragstart .module":"dragstart","drag .module":"drag","dragstop .module":"dragstop","resizestart .module":"resizestart","resize .module":"resize","resizestop .module":"resizestop","mousedown .module, .title":"mousedown","click .module, .title":"click","click .showcontrols":"showControls","click .hidecontrols":"hideControls","click .remove":"removeModel"},initialize:function(){this.render(),this.$(".module").data({view:this}).draggable({handle:"h1"}).resizable({minHeight:100,minWidth:100}),this.$(".showcontrols").button({icons:{primary:"icon-left-open"},text:!1}),this.$(".hidecontrols").button({icons:{primary:"icon-right-open"},text:!1}),this.$(".remove").button({icons:{primary:"icon-trash"},text:!1}),this.$("h1").disableSelection(),this.mousedown()},initializeNative:function(){this.Native||(Iframework.NativeNodes.hasOwnProperty(this.model.lazyLoadType)?(this.Native=new Iframework.NativeNodes[this.model.lazyLoadType]({model:this.model}),this.$(".inner").append(this.Native.initialize().$el),this.model.loaded=!0,this.model.graph.checkLoaded()):console.warn("No native node found."))},render:function(){return this.$el.html(this.template(this.model)),this},infoLoaded:function(a){this.$("h1").text(this.model.get("id")+": "+a.title).attr({title:(a.author?"by "+a.author+": ":"")+a.description})},_relatedEdges:null,relatedEdges:function(){if(this._relatedEdges===null){var a=[];this.model.Inputs.each(function(b){b.Edges.each(function(b){a.push(b)})}),this.model.Outputs.each(function(b){b.Edges.each(function(b){a.push(b)})}),this._relatedEdges=a}return this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},_delta:{},dragstart:function(a,b){this.model.graph.view.maskFrames(),this.$(".module").hasClass("ui-selected")||($("div.module.ui-selected").removeClass("ui-selected"),this.$(".module").addClass("ui-selected")),this.model.graph.view.selectableStop(),this._delta=this.$(".module").offset()},drag:function(a,b){_.each(this.relatedEdges(),function(a){a.view&&a.view.redraw()});if(a&&b){var c=this.model.graph.view._selected,d=this._delta.left-b.offset.left-$(".graph").scrollLeft(),e=this._delta.top-b.offset.top-$(".graph").scrollTop();for(var f=0;f<c.length;f++)this.$(".module")[0]!==c[f].el&&($(c[f].el).css({left:c[f].offset.left-d+"px",top:c[f].offset.top-e+"px"}),c[f].view.drag())}},dragstop:function(a,b){this.drag(),this.model.set({x:this.$(".module").offset().left+10+$(".graph").scrollLeft(),y:this.$(".module").offset().top+30+$(".graph").scrollTop()});if(a){this.model.graph.view.unmaskFrames();var c=this.model.graph.view._selected;for(var d=0;d<c.length;d++)this.$(".module")[0]!==c[d].el&&c[d].view.dragstop();this.model.graph.view.resizeEdgeSVG()}},resizestart:function(a,b){this.model.graph.view.maskFrames()},resize:function(a,b){this.drag()},resizestop:function(a,b){this.model.graph.view.unmaskFrames();var c=b.size.width,d=b.size.height;this.model.set({w:c-20,h:d-40}),this.Native&&this.Native.resize(c,d),this.model.graph.view.resizeEdgeSVG(),this.drag()},mousedown:function(a,b){var c=0;$("div.module").each(function(){var a=Number($(this).css("z-index"));a>c&&(c=a)}),this.$(".module").css("z-index",c+1),a&&a.stopPropagation()},click:function(a){a&&a.hasOwnProperty("metaKey")&&(a.metaKey===!1?($("div.module.ui-selected").removeClass("ui-selected"),this.select()):this.$(".module").hasClass("ui-selected")?this.$(".module").removeClass("ui-selected"):this.select()),this.model.graph.view&&this.model.graph.view.selectableStop(),a.stopPropagation()},select:function(){this.$(".module").addClass("ui-selected")},addInput:function(a){this.$(".ports-in").append(a.initializeView().el)},addOutput:function(a){this.$(".ports-out").append(a.initializeView().el)},showControls:function(){this.$(".showcontrols").hide(),this.$(".controls").show()},hideControls:function(){this.$(".showcontrols").show(),this.$(".controls").hide()},removeModel:function(){this.model.remove(!0)},remove:function(){this.Native&&this.Native.remove(),this.$el.remove()},refresh:function(){}})}),$(function(){var a='<div class="info" />';Iframework.NodeBoxNativeView=Backbone.View.extend({tagName:"div",className:"nativenode",template:_.template(a),info:{title:"native-node-view",description:"extend me"},inputs:{},outputs:{},initialize:function(){this.render(),this.model.infoLoaded(this.info);for(var a in this.inputs)if(this.inputs.hasOwnProperty(a)){var b=this.inputs[a];b.name=a,this.model.addInput(b)}for(var c in this.outputs)if(this.outputs.hasOwnProperty(c)){var d=this.outputs[c];d.name=c,this.model.addOutput(d)}return this.initializeCategory(),this.initializeModule(),this},initializeCategory:function(){},initializeModule:function(){},render:function(){return this.$el.html(this.template(this.model)),this},redraw:function(a){},_triggerRedraw:!1,renderAnimationFrame:function(a){this._triggerRedraw&&(this._triggerRedraw=!1,this.redraw(a))},send:function(a,b){this.model.send(a,b)},toString:function(){return"Native view: "+this.model.get("id")+": "+this.info.title},resize:function(a,b){},connectEdge:function(a){},disconnectEdge:function(a){},remove:function(){}})}),$(function(){Iframework.NodeBoxIframe=Iframework.NodeBox.extend({initializeView:function(){return this.view=new Iframework.NodeBoxIframeView({model:this}),this.view},info:{title:"iframe-node",description:"extend me"},sendFromFrame:function(a){var b=this.Outputs.get(a.output);!b||b.send(a.value)},receive:function(a){window.frames[this.frameIndex]?window.frames[this.frameIndex].postMessage(a,"*"):console.error("wat "+this.id+" "+this.frameIndex)},setState:function(){var a=this.get("state");a&&this.receive({setState:a})},iframeLoaded:function(){this.loaded=!0,this.graph.checkLoaded()},toString:function(){return this.info?"Iframe node "+this.get("id")+": "+this.info.title:"Iframe node "+this.get("id")}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var a='<iframe class="iframe" name="<%= frameIndex %>" src="<%= get("src") %>"></iframe>';Iframework.NodeBoxIframeView=Iframework.NodeBoxView.extend({innerTemplate:_.template(a),initialize:function(){Iframework.NodeBoxView.prototype.initialize.call(this),this.$(".inner").addClass("iframe-type")},render:function(){return this.$el.html(this.template(this.model)),this.$(".inner").html(this.innerTemplate(this.model)),this},refresh:function(){this.$("iframe")[0].src=this.model.get("src")}})}),$(function(){Iframework.Port=Backbone.Model.extend({defaults:{name:"",type:"",description:"","default":null},initialize:function(){this.get("type")===""&&this.set("type","all"),this.set("type_class",this.get("type").split(":")[0]),this.Edges=new Iframework.Edges},connect:function(a){this.Edges.add(a)},disconnect:function(a){this.Edges.remove(a)}}),Iframework.Ports=Backbone.Collection.extend({model:Iframework.Port})}),$(function(){var a='<div class="edge-edit"><button class="close">close</button><h2><%= name %> (<%= type %>)</h2><p><%= description %></p></div>',b='<div class="edge-edit-item" id="<%= model.cid %>"><span><%= label() %></span><button class="disconnect" type="button">disconnect</button></div>';Iframework.PortView=Backbone.View.extend({tagName:"div",className:"port",popupTemplate:_.template(a),edgeEditTemplate:_.template(b),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},initialize:function(){return this.render(),this},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name");if(Iframework.selectedPort&&c!==Iframework.selectedPort.isIn){var e;c?e=new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):e=new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),e.graph=Iframework.shownGraph,e.graph.addEdge(e)&&e.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=undefined),Iframework.selectedPort=null;return}var f=this.popupTemplate(this.model.toJSON());f=$(f),this.$el.append(f),f.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var g=this.model.get("type").substring(0,3);if(c){var h=!1,i=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if(g==="int"||g==="num"||g==="flo")h=!0,i.append($("<input />").attr({type:"number",min:b.data("min"),max:b.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="col"||g==="str")h=!0,i.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="boo"){h=!0;var j=this.model.node.get("state")[this.model.get("name")];j=Boolean(j)&&j!=="false",i.append($("<input />").attr({type:"checkbox",checked:j}))}else g==="ban"&&(i.append("<label>Send bang:</label> "),h=!0);h&&(i.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),f.append(i))}$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(f.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);f.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(a){var b=this.model.get("name"),c;this.$(".manualinput").children("input")&&(c=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(this.$(".manualinput").children("input:checkbox").is(":checked")?c=!0:c=!1),this.model.get("type")==="int"&&(c=parseInt(c,10));if(this.model.get("type")==="number"||this.model.get("type")==="float")c=parseFloat(c);c===undefined&&(c="!");var d={};return d[b]=c,this.model.node.receive(d),this.model.node.get("state")[b]=c,this.model.node.trigger("change"),!1},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortIn=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this})},receive:function(a){var b={};b[this.id]=a,this.node.receive(b)}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){var a='<div class="portshown portshown-in"><span class="hole hole-in hole-<%= type_class %> icon-login"></span><span class="label"><%= name %></span></div><span class="plugend plugend-in plugend-<%= type_class %>"></span>';Iframework.PortInView=Iframework.PortView.extend({tagName:"div",className:"port",portInTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},render:function(){this.$el.html(this.portInTemplate(this.model.toJSON())),this.$el.addClass("port-in"),this.$(".hole").draggable({helper:function(a){return $('<span class="holehelper holehelper-out" />')}}),this.$(".plugend").draggable({helper:function(a){return $('<span class="plugendhelper plugendhelper-in" />')}}),this.$(".hole").data({model:this.model});var a="";if(this.model.get("type")==="all")this.model.isIn?a=".hole-out, .plugend-in":a=".hole-in, .plugend-out";else{var b=this.model.get("type_class");this.model.isIn?a=".hole-out.hole-all, .hole-out.hole-"+b+", .plugend-in.plugend-all, .plugend-in.plugend-"+b:a=".hole-in.hole-all, .hole-in.hole-"+b+", .plugend-out.plugend-all, .plugend-out.plugend-"+b}this.model.isIn&&this.model.get("type")==="string"&&(a+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float"),!this.model.isIn&&(this.model.get("type")==="int"||this.model.get("type")==="float")&&(a+=", .hole-in.hole-string, .plugend-out.plugend-string"),this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name");if(Iframework.selectedPort&&c!==Iframework.selectedPort.isIn){var e;c?e=new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):e=new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),e.graph=Iframework.shownGraph,e.graph.addEdge(e)&&e.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=undefined),Iframework.selectedPort=null;return}var f=this.popupTemplate(this.model.toJSON());f=$(f),this.$el.append(f),f.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var g=this.model.get("type").substring(0,3),h=!1,i=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if(g==="int"||g==="num"||g==="flo")h=!0,i.append($("<input />").attr({type:"number",min:b.data("min"),max:b.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="col"||g==="str")h=!0,i.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="boo"){h=!0;var j=this.model.node.get("state")[this.model.get("name")];j=Boolean(j)&&j!=="false",i.append($("<input />").attr({type:"checkbox",checked:j}))}else g==="ban"&&(i.append("<label>Send bang:</label> "),h=!0);h&&(i.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),f.append(i)),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(f.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);f.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(a){var b=this.model.get("name"),c,d=!0;this.$(".manualinput").children("input")&&(c=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(this.$(".manualinput").children("input:checkbox").is(":checked")?c=!0:c=!1),this.model.get("type")==="int"&&(c=parseInt(c,10));if(this.model.get("type")==="number"||this.model.get("type")==="float")c=parseFloat(c);c===undefined&&(c="!",d=!1);var e={};e[b]=c,this.model.node.receive(e);if(d){var f={};f[b]=c,this.model.node.setValue(f)}return!1},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortInImage=Iframework.PortIn.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this})},getCanvas:function(a){this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"));if(this.canvas.width!==a.width||this.canvas.height!==a.height)this.canvas.width=a.width,this.canvas.height=a.height;return this.canvas},putImageDataToCanvas:function(a){return this.getCanvas(a),this.context.putImageData(a,0,0),this.canvas},drawToCanvas:function(a){return this.getCanvas(a),this.context.drawImage(a,0,0),this.canvas},receive:function(a){var b=Iframework.util.type(a),c=this,d,e,f;if(this.node.view.Native&&b==="ImageData")d||(d=c.putImageDataToCanvas(a)),a=e;else if(!this.node.view.Native&&b!=="ImageData"){if(!a.getContext||!a.getContext("2d"))e||(e=this.drawToCanvas(a),a=e);f||(f=a.getContext("2d").getImageData(0,0,a.width,a.height)),a=f}var g={};g[this.id]=a,this.node.receive(g)}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){Iframework.PortOut=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortOutView({model:this})},send:function(a){this.Edges.each(function(b){_.defer(function(){b.Target.receive(a)})})}}),Iframework.PortsOut=Backbone.Collection.extend({model:Iframework.PortOut})}),$(function(){var a='<div class="portshown portshown-out"><span class="label"><%= name %></span><span class="hole hole-out hole-<%= type_class %> icon-logout"></span></div><span class="plugend plugend-out plugend-<%= type_class %>"></span>';Iframework.PortOutView=Iframework.PortView.extend({tagName:"div",className:"port",portOutTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect"},render:function(){this.$el.html(this.portOutTemplate(this.model.toJSON())),this.$el.addClass("port-out"),this.$(".hole").draggable({helper:function(a){return $('<span class="holehelper holehelper-in" />')}}),this.$(".plugend").draggable({helper:function(a){return $('<span class="plugendhelper plugendhelper-out" />')}}),this.$(".hole").data({model:this.model});var a="";if(this.model.get("type")==="all")this.model.isIn?a=".hole-out, .plugend-in":a=".hole-in, .plugend-out";else{var b=this.model.get("type_class");this.model.isIn?a=".hole-out.hole-all, .hole-out.hole-"+b+", .plugend-in.plugend-all, .plugend-in.plugend-"+b:a=".hole-in.hole-all, .hole-in.hole-"+b+", .plugend-out.plugend-all, .plugend-out.plugend-"+b}this.model.isIn&&this.model.get("type")==="string"&&(a+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float"),!this.model.isIn&&(this.model.get("type")==="int"||this.model.get("type")==="float")&&(a+=", .hole-in.hole-string, .plugend-out.plugend-string"),this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name"),e=this.popupTemplate(this.model.toJSON());e=$(e),this.$el.append(e),e.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var f=this.model.get("type").substring(0,3);$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(e.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);e.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortOutImage=Iframework.PortOut.extend({getCanvas:function(a){this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"));if(this.canvas.width!==a.width||this.canvas.height!==a.height)this.canvas.width=a.width,this.canvas.height=a.height;return this.canvas},putImageDataToCanvas:function(a){return this.getCanvas(a),this.context.putImageData(a,0,0),this.canvas},drawToCanvas:function(a){return this.getCanvas(a),this.context.drawImage(a,0,0),this.canvas},send:function(a){var b=Iframework.util.type(a),c=this,d,e,f;this.Edges.each(function(g){_.defer(function(){if(g.Target.node.view.Native&&b==="ImageData")d||(d=c.putImageDataToCanvas(a)),g.Target.receive(d);else if(!g.Target.node.view.Native&&b!=="ImageData"){if(!a.getContext||!a.getContext("2d"))e||(e=c.drawToCanvas(a),a=e);f||(f=a.getContext("2d").getImageData(0,0,a.width,a.height)),g.Target.receive(f)}else g.Target.receive(a)})})}})}),$(function(){Iframework.Module=Backbone.Model.extend({defaults:{src:"",info:{}},initialize:function(){},initializeView:function(){return this.view||(this.view=new Iframework.ModuleView({model:this})),this.view},toJSON:function(){return{src:this.get("src"),info:this.get("info")}}}),Iframework.Modules=Backbone.Collection.extend({model:Iframework.Module,findOrAdd:function(a){var b;return b=this.find(function(b){return b.get("src")===a.get("src")}),b||(b=new Iframework.Module({node:a}),this.add(b)),b}})}),$(function(){var a='<div class="addnode" type="button">drag to graph</div><h2 class="title"><%= info.title %></h2><p class="description"><%= info.description %></p><p class="src"><%= src %></p>';Iframework.ModuleView=Backbone.View.extend({tagName:"div",className:"library-module",template:_.template(a),events:{"click .addnode":"addNode","dragstart .addnode":"dragStart","dragstop .addnode":"dragStop"},initialize:function(){return this.render(),this.$(".addnode").data({module:this.model}).button({icons:{primary:"icon-window"},text:!1}).draggable({helper:function(){var a=$('<div class="addnode-drag-helper" />').text($(this).data("module").get("info").title);return $(".app").append(a),a}}),this},render:function(){this.$el.html(this.template(this.model.toJSON()))},addNode:function(a){Iframework.$(".addbyurlinput").val(this.model.get("src")),Iframework.addByUrl(a)},dragAddNode:function(a){a.src=this.model.get("src"),Iframework.shownGraph.addNode(a)},dragStart:function(){Iframework.shownGraph.view.maskFrames()},dragStop:function(){Iframework.shownGraph.view.unmaskFrames()}})}),$(function(){Iframework.Edge=Backbone.Model.extend({defaults:{source:[0,"default"],target:[0,"default"]},initialize:function(){},initializeView:function(){return this.view=new Iframework.EdgeView({model:this}),this.view},Source:null,Target:null,connectTryCount:5,connected:!1,connect:function(){try{this.Source=this.graph.get("nodes").get(this.get("source")[0]).Outputs.get(this.get("source")[1]),this.Target=this.graph.get("nodes").get(this.get("target")[0]).Inputs.get(this.get("target")[1])}catch(a){console.warn("Edge source or target port not found, try #"+this.connectTryCount+": "+this.toString());if(this.connectTryCount>0){this.connectTryCount--;var b=this;_.delay(function(){b.connect()},1e3)}return!1}return!this.Source||!this.Target?!1:(this.Source.connect(this),this.Target.connect(this),this.Source.node.receive({connect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.graph.view&&this.graph.view.addEdge(this),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.connectEdge(this),this.connected=!0,this)},disconnect:function(){this.Source&&this.Target&&(this.Source.disconnect(this),this.Target.disconnect(this),this.Source.node.receive({disconnect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.disconnectEdge(this)),this.view&&this.view.remove(),this.connected=!1},remove:function(){this.graph.removeEdge(this)},toString:function(){return this.get("source")[0]+":"+this.get("source")[1]+"->"+this.get("target")[0]+":"+this.get("target")[1]}}),Iframework.Edges=Backbone.Collection.extend({model:Iframework.Edge})}),$(function(){Iframework.EdgeView=Backbone.View.extend({tagName:"div",className:"edge",positions:null,graphSVGElement:null,elementGroup:null,elementWire:null,elementShadow:null,isPreview:!1,initialize:function(){this.graphSVGElement=document.getElementById("edgesSvg"),this.positions={fromX:0,fromY:0,toX:0,toY:0},this.model||(this.isPreview=!0),this.model&&this.model._color&&(this._color=this.model._color),this.render(),this.model&&(this._z=this.model.graph.edgeCount++,$(this.elementWire).data({model:this.model}).click(function(a){$(a.target).data("model").view.click(a)}))},render:function(){return this.calcPositions(),this.elementGroup=this.makeSVG("g",{transform:"translate("+this.svgX()+","+this.svgY()+")","class":"wire-group"+(this.isPreview?" preview":"")}),this.elementShadow=this.makeSVG("path",{"class":"wire-shadow",d:this.svgPathShadow()}),this.elementWire=this.makeSVG("path",{"class":"wire",d:this.svgPath(),stroke:this.color()}),this.elementGroup.appendChild(this.elementShadow),this.elementGroup.appendChild(this.elementWire),this.graphSVGElement.appendChild(this.elementGroup),this.model&&(this.model.Source.view.$(".plugend").show(),this.model.Target.view.$(".plugend").show()),this},redraw:function(){this.calcPositions(),$(this.elementGroup).attr("transform","translate("+this.svgX()+", "+this.svgY()+")"),$(this.elementWire).attr("d",this.svgPath()),$(this.elementShadow).attr("d",this.svgPathShadow())},remove:function(){$(this.elementGroup).remove()},setPositions:function(a){this.positions=a},calcPositions:function(){if(this.model){var a=this.model.get("source")[1],b=this.model.get("target")[1];this.positions.fromX=this.model.Source.view.portOffsetLeft("out",a),this.positions.fromY=this.model.Source.view.portOffsetTop("out",a),this.positions.toX=this.model.Target.view.portOffsetLeft("in",b),this.positions.toY=this.model.Target.view.portOffsetTop("in",b)}},svgX:function(){return Math.min(this.positions.toX,this.positions.fromX)-50},svgY:function(){return Math.min(this.positions.toY,this.positions.fromY)-25},svgW:function(){return Math.abs(this.positions.toX-this.positions.fromX)+100},svgH:function(){return Math.abs(this.positions.toY-this.positions.fromY)+50},pathStraight:35,pathCurve:60,svgPath:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY(),c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY();return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},svgPathShadow:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY()+1,c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY()+1;return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},color:function(){return this._color?this._color:this.model?this._color=Iframework.getWireColor():Iframework.wireColors[Iframework.wireColorIndex]},setColor:function(a){this._color=a,$(this.elementWire).attr("stroke",a)},label:function(){return this.model.get("source")[0]+":"+this.model.get("source")[1]+'<span class="wiresymbol" style="color:'+this._color+'">&rarr;</span>'+this.model.get("target")[0]+":"+this.model.get("target")[1]},makeSVG:function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)d==="xlink:href"?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c},dim:function(){$(this.elementGroup).attr("opacity",.2)},undim:function(){$(this.elementGroup).attr("opacity",1)},click:function(a){this._z<this.model.graph.edgeCount-1&&(this.graphSVGElement.appendChild(this.elementGroup),this._z=this.model.graph.edgeCount++),this.highlight()},highlight:function(){var a=$(this.elementShadow);a.attr("class","wire-shadow highlight"),setTimeout(function(){a.attr("class","wire-shadow")},1e3),this.model.Source.view&&this.model.Source.view.highlight(),this.model.Target.view&&this.model.Target.view.highlight()}})}),$(function(){var a=Backbone.Router.extend({routes:{"example/:url":"loadExample","new":"newBlank","local/:url":"loadLocal","gist/https://gist.github.com/:id":"loadGistUgly","gist/:id":"loadGist","*path":"default"},loadExample:function(a){Iframework.loadExample(a)},loadGistUgly:function(a){this.navigate("gist/"+a,{replace:!0}),this.loadGist(a)},loadLocal:function(a){Iframework.loadLocal(a)},loadGist:function(a){Iframework.loadFromGistId(a)},newBlank:function(){Iframework.newBlank()},"default":function(){}});Iframework.router=new a,Backbone.history.start()}),$(function(){Iframework.allLoaded(),Mousetrap.bind(["command+a","ctrl+a"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&(a.preventDefault(),Iframework.shownGraph.view.selectAll())}),Mousetrap.bind(["command+x","ctrl+x"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&(a.preventDefault(),Iframework.shownGraph.view.cut())}),Mousetrap.bind(["command+c","ctrl+c"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&(a.preventDefault(),Iframework.shownGraph.view.copy())}),Mousetrap.bind(["command+v","ctrl+v"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&(a.preventDefault(),Iframework.shownGraph.view.paste())})});