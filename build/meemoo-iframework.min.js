/*! Meemoo Iframework - v0.3 - 2013-04-06 (10:52:05 AM GMT+0300)
* http://meemoo.org/
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, AGPL 
*/
(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=e.toString,k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?(this._wrapped=a,void 0):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.4.4";var y=x.each=x.forEach=function(a,b,d){if(null!=a)if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g in a)if(x.has(a,g)&&b.call(d,a[g],g,a)===c)return};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)};var z="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(z);return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError(z);return c},x.find=x.detect=function(a,b,c){var d;return A(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},x.reject=function(a,b,c){return x.filter(a,function(a,d,e){return!b.call(c,a,d,e)},c)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){return(e=e&&b.call(d,a,f,g))?void 0:c}),!!e)};var A=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){return e||(e=b.call(d,a,f,g))?c:void 0}),!!e)};x.contains=x.include=function(a,b){return null==a?!1:s&&a.indexOf===s?a.indexOf(b)!=-1:A(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2),d=x.isFunction(b);return x.map(a,function(a){return(d?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,function(a){return a[b]})},x.where=function(a,b,c){return x.isEmpty(b)?c?null:[]:x[c?"find":"filter"](a,function(a){for(var c in b)if(b[c]!==a[c])return!1;return!0})},x.findWhere=function(a,b){return x.where(a,b,!0)},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&65535>a.length)return Math.max.apply(Math,a);if(!b&&x.isEmpty(a))return-1/0;var d={computed:-1/0,value:-1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&65535>a.length)return Math.min.apply(Math,a);if(!b&&x.isEmpty(a))return 1/0;var d={computed:1/0,value:1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;d.computed>g&&(d={value:a,computed:g})}),d.value},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d};var B=function(a){return x.isFunction(a)?a:function(b){return b[a]}};x.sortBy=function(a,b,c){var d=B(b);return x.pluck(x.map(a,function(a,b,e){return{value:a,index:b,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||c===void 0)return 1;if(d>c||d===void 0)return-1}return a.index<b.index?-1:1}),"value")};var C=function(a,b,c,d){var e={},f=B(b||x.identity);return y(a,function(b,g){var h=f.call(c,b,g,a);d(e,h,b)}),e};x.groupBy=function(a,b,c){return C(a,b,c,function(a,b,c){(x.has(a,b)?a[b]:a[b]=[]).push(c)})},x.countBy=function(a,b,c){return C(a,b,c,function(a,b){x.has(a,b)||(a[b]=0),a[b]++})},x.sortedIndex=function(a,b,c,d){c=null==c?x.identity:B(c);for(var e=c.call(d,b),f=0,g=a.length;g>f;){var h=f+g>>>1;e>c.call(d,a[h])?f=h+1:g=h}return f},x.toArray=function(a){return a?x.isArray(a)?h.call(a):a.length===+a.length?x.map(a,x.identity):x.values(a):[]},x.size=function(a){return null==a?0:a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,x.identity)};var D=function(a,b,c){return y(a,function(a){x.isArray(a)?b?g.apply(c,a):D(a,b,c):c.push(a)}),c};x.flatten=function(a,b){return D(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.uniq=x.unique=function(a,b,c,d){x.isFunction(b)&&(d=c,c=b,b=!1);var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(i.apply(d,arguments))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.indexOf(b,a)>=0})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=h.call(arguments),b=x.max(x.pluck(a,"length")),c=Array(b),d=0;b>d;d++)c[d]=x.pluck(a,""+d);return c},x.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;e>d;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);d>e;)f[e++]=a,a+=c;return f},x.bind=function(a,b){if(a.bind===w&&w)return w.apply(a,h.call(arguments,1));var c=h.call(arguments,2);return function(){return a.apply(b,c.concat(h.call(arguments)))}},x.partial=function(a){var b=h.call(arguments,1);return function(){return a.apply(this,b.concat(h.call(arguments)))}},x.bindAll=function(a){var b=h.call(arguments,1);return 0===b.length&&(b=x.functions(a)),y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b){var c,d,e,f,g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)};return function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},x.debounce=function(a,b,c){var d,e;return function(){var f=this,g=arguments,h=function(){d=null,c||(e=a.apply(f,g))},i=c&&!d;return clearTimeout(d),d=setTimeout(h,b),i&&(e=a.apply(f,g)),e}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return function(){var c=[a];return g.apply(c,arguments),b.apply(this,c)}},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return 0>=a?b():function(){return 1>--a?b.apply(this,arguments):void 0}},x.keys=v||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)x.has(a,c)&&(b[b.length]=c);return b},x.values=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push(a[c]);return b},x.pairs=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push([c,a[c]]);return b},x.invert=function(a){var b={};for(var c in a)x.has(a,c)&&(b[a[c]]=c);return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)null==a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var E=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==b+"";case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;c.push(a),d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=a.length,h=g==b.length)for(;g--&&(h=E(a[g],b[g],c,d)););}else{var i=a.constructor,k=b.constructor;if(i!==k&&!(x.isFunction(i)&&i instanceof i&&x.isFunction(k)&&k instanceof k))return!1;for(var l in a)if(x.has(a,l)&&(g++,!(h=x.has(b,l)&&E(a[l],b[l],c,d))))break;if(h){for(l in b)if(x.has(b,l)&&!(g--))break;h=!g}}return c.pop(),d.pop(),h};x.isEqual=function(a,b){return E(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!!a&&1===a.nodeType},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!!a&&!!x.has(a,"callee")}),"function"!=typeof /./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return a===void 0},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.times=function(a,b,c){for(var d=Array(a),e=0;a>e;e++)d[e]=b.call(c,e);return d},x.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))};var F={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};F.unescape=x.invert(F.escape);var G={escape:RegExp("["+x.keys(F.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(F.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(G[a],function(b){return F[a][b]})}}),x.result=function(a,b){if(null==a)return null;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),L.call(this,c.apply(x,a))}})};var H=0;x.uniqueId=function(a){var b=++H+"";return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,J={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},K=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){var d;c=x.defaults({},c,x.templateSettings);var e=RegExp([(c.escape||I).source,(c.interpolate||I).source,(c.evaluate||I).source].join("|")+"|$","g"),f=0,g="__p+='";a.replace(e,function(b,c,d,e,h){return g+=a.slice(f,h).replace(K,function(a){return"\\"+J[a]}),c&&(g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&(g+="'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&(g+="';\n"+e+"\n__p+='"),f=h+b.length,b}),g+="';\n",c.variable||(g="with(obj||{}){\n"+g+"}\n"),g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{d=Function(c.variable||"obj","_",g)}catch(h){throw h.source=g,h}if(b)return d(b,x);var i=function(a){return d.call(this,a,x)};return i.source="function("+(c.variable||"obj")+"){\n"+g+"}",i},x.chain=function(a){return x(a).chain()};var L=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],L.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return L.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(){var a=this,b=a.Backbone,c=[],d=c.push,e=c.slice,f=c.splice,g;typeof exports!="undefined"?g=exports:g=a.Backbone={},g.VERSION="1.0.0";var h=a._;!h&&typeof require!="undefined"&&(h=require("underscore")),g.$=a.jQuery||a.Zepto||a.ender||a.$,g.noConflict=function(){return a.Backbone=b,this},g.emulateHTTP=!1,g.emulateJSON=!1;var i=g.Events={on:function(a,b,c){if(!k(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!k(this,"once",a,[b,c])||!b)return this;var d=this,e=h.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,i,j,l,m;if(!this._events||!k(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;g=a?[a]:h.keys(this._events);for(i=0,j=g.length;i<j;i++){a=g[i];if(f=this._events[a]){this._events[a]=d=[];if(b||c)for(l=0,m=f.length;l<m;l++)e=f[l],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}}return this},trigger:function(a){if(!this._events)return this;var b=e.call(arguments,1);if(!k(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&l(c,b),d&&l(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;typeof b=="object"&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}},j=/\s+/,k=function(a,b,c,d){if(!c)return!0;if(typeof c=="object"){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(j.test(c)){var f=c.split(j);for(var g=0,h=f.length;g<h;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},l=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:while(++d<e)(c=a[d]).callback.call(c.ctx);return;case 1:while(++d<e)(c=a[d]).callback.call(c.ctx,f);return;case 2:while(++d<e)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:while(++d<e)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:while(++d<e)(c=a[d]).callback.apply(c.ctx,b)}},m={listenTo:"on",listenToOnce:"once"};h.each(m,function(a,b){i[b]=function(b,c,d){var e=this._listeners||(this._listeners={}),f=b._listenerId||(b._listenerId=h.uniqueId("l"));return e[f]=b,typeof c=="object"&&(d=this),b[a](c,d,this),this}}),i.bind=i.on,i.unbind=i.off,h.extend(g,i);var n=g.Model=function(a,b){var c,d=a||{};b||(b={}),this.cid=h.uniqueId("c"),this.attributes={},h.extend(this,h.pick(b,o)),b.parse&&(d=this.parse(d,b)||{});if(c=h.result(this,"defaults"))d=h.defaults({},d,c);this.set(d,b),this.changed={},this.initialize.apply(this,arguments)},o=["url","urlRoot","collection"];h.extend(n.prototype,i,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(a){return h.clone(this.attributes)},sync:function(){return g.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return h.escape(this.get(a))},has:function(a){return this.get(a)!=null},set:function(a,b,c){var d,e,f,g,i,j,k,l;if(a==null)return this;typeof a=="object"?(e=a,c=b):(e={})[a]=b,c||(c={});if(!this._validate(e,c))return!1;f=c.unset,i=c.silent,g=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=h.clone(this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],h.isEqual(l[d],b)||g.push(d),h.isEqual(k[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete l[d]:l[d]=b;if(!i){g.length&&(this._pending=!0);for(var m=0,n=g.length;m<n;m++)this.trigger("change:"+g[m],this,l[g[m]],c)}if(j)return this;if(!i)while(this._pending)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,void 0,h.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var c in this.attributes)b[c]=void 0;return this.set(b,h.extend({},a,{unset:!0}))},hasChanged:function(a){return a==null?!h.isEmpty(this.changed):h.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?h.clone(this.changed):!1;var b,c=!1,d=this._changing?this._previousAttributes:this.attributes;for(var e in a){if(h.isEqual(d[e],b=a[e]))continue;(c||(c={}))[e]=b}return c},previous:function(a){return a==null||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return h.clone(this._previousAttributes)},fetch:function(a){a=a?h.clone(a):{},a.parse===void 0&&(a.parse=!0);var b=this,c=a.success;return a.success=function(d){if(!b.set(b.parse(d,a),a))return!1;c&&c(b,d,a),b.trigger("sync",b,d,a)},L(this,a),this.sync("read",this,a)},save:function(a,b,c){var d,e,f,g=this.attributes;a==null||typeof a=="object"?(d=a,c=b):(d={})[a]=b;if(d&&(!c||!c.wait)&&!this.set(d,c))return!1;c=h.extend({validate:!0},c);if(!this._validate(d,c))return!1;d&&c.wait&&(this.attributes=h.extend({},g,d)),c.parse===void 0&&(c.parse=!0);var i=this,j=c.success;return c.success=function(a){i.attributes=g;var b=i.parse(a,c);c.wait&&(b=h.extend(d||{},b));if(h.isObject(b)&&!i.set(b,c))return!1;j&&j(i,a,c),i.trigger("sync",i,a,c)},L(this,c),e=this.isNew()?"create":c.patch?"patch":"update",e==="patch"&&(c.attrs=d),f=this.sync(e,this,c),d&&c.wait&&(this.attributes=g),f},destroy:function(a){a=a?h.clone(a):{};var b=this,c=a.success,d=function(){b.trigger("destroy",b,b.collection,a)};a.success=function(e){(a.wait||b.isNew())&&d(),c&&c(b,e,a),b.isNew()||b.trigger("sync",b,e,a)};if(this.isNew())return a.success(),!1;L(this,a);var e=this.sync("delete",this,a);return a.wait||d(),e},url:function(){var a=h.result(this,"urlRoot")||h.result(this.collection,"url")||K();return this.isNew()?a:a+(a.charAt(a.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(a){return this._validate({},h.extend(a||{},{validate:!0}))},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=h.extend({},this.attributes,a);var c=this.validationError=this.validate(a,b)||null;return c?(this.trigger("invalid",this,c,h.extend(b||{},{validationError:c})),!1):!0}});var p=["keys","values","pairs","invert","pick","omit"];h.each(p,function(a){n.prototype[a]=function(){var b=e.call(arguments);return b.unshift(this.attributes),h[a].apply(h,b)}});var q=g.Collection=function(a,b){b||(b={}),b.url&&(this.url=b.url),b.model&&(this.model=b.model),b.comparator!==void 0&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,h.extend({silent:!0},b))},r={add:!0,remove:!0,merge:!0},s={add:!0,merge:!1,remove:!1};h.extend(q.prototype,i,{model:n,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return g.sync.apply(this,arguments)},add:function(a,b){return this.set(a,h.defaults(b||{},s))},remove:function(a,b){a=h.isArray(a)?a.slice():[a],b||(b={});var c,d,e,f;for(c=0,d=a.length;c<d;c++){f=this.get(a[c]);if(!f)continue;delete this._byId[f.id],delete this._byId[f.cid],e=this.indexOf(f),this.models.splice(e,1),this.length--,b.silent||(b.index=e,f.trigger("remove",f,this,b)),this._removeReference(f)}return this},set:function(a,b){b=h.defaults(b||{},r),b.parse&&(a=this.parse(a,b)),h.isArray(a)||(a=a?[a]:[]);var c,e,g,i,j,k,l=b.at,m=this.comparator&&l==null&&b.sort!==!1,n=h.isString(this.comparator)?this.comparator:null,o=[],p=[],q={};for(c=0,e=a.length;c<e;c++){if(!(g=this._prepareModel(a[c],b)))continue;(j=this.get(g))?(b.remove&&(q[j.cid]=!0),b.merge&&(j.set(g.attributes,b),m&&!k&&j.hasChanged(n)&&(k=!0))):b.add&&(o.push(g),g.on("all",this._onModelEvent,this),this._byId[g.cid]=g,g.id!=null&&(this._byId[g.id]=g))}if(b.remove){for(c=0,e=this.length;c<e;++c)q[(g=this.models[c]).cid]||p.push(g);p.length&&this.remove(p,b)}o.length&&(m&&(k=!0),this.length+=o.length,l!=null?f.apply(this.models,[l,0].concat(o)):d.apply(this.models,o)),k&&this.sort({silent:!0});if(b.silent)return this;for(c=0,e=o.length;c<e;c++)(g=o[c]).trigger("add",g,this,b);return k&&this.trigger("sort",this,b),this},reset:function(a,b){b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c]);return b.previousModels=this.models,this._reset(),this.add(a,h.extend({silent:!0},b)),b.silent||this.trigger("reset",this,b),this},push:function(a,b){return a=this._prepareModel(a,b),this.add(a,h.extend({at:this.length},b)),a},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return a=this._prepareModel(a,b),this.add(a,h.extend({at:0},b)),a},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(a,b){return this.models.slice(a,b)},get:function(a){return a==null?void 0:this._byId[a.id!=null?a.id:a.cid||a]},at:function(a){return this.models[a]},where:function(a,b){return h.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),h.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(h.bind(this.comparator,this)),a.silent||this.trigger("sort",this,a),this},sortedIndex:function(a,b,c){b||(b=this.comparator);var d=h.isFunction(b)?b:function(a){return a.get(b)};return h.sortedIndex(this.models,a,d,c)},pluck:function(a){return h.invoke(this.models,"get",a)},fetch:function(a){a=a?h.clone(a):{},a.parse===void 0&&(a.parse=!0);var b=a.success,c=this;return a.success=function(d){var e=a.reset?"reset":"set";c[e](d,a),b&&b(c,d,a),c.trigger("sync",c,d,a)},L(this,a),this.sync("read",this,a)},create:function(a,b){b=b?h.clone(b):{};if(!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var c=this,d=b.success;return b.success=function(e){b.wait&&c.add(a,b),d&&d(a,e,b)},a.save(null,b),a},parse:function(a,b){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof n)return a.collection||(a.collection=this),a;b||(b={}),b.collection=this;var c=new this.model(a,b);return c._validate(a,b)?c:(this.trigger("invalid",this,a,b),!1)},_removeReference:function(a){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){if(a!=="add"&&a!=="remove"||c===this)a==="destroy"&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],b.id!=null&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments);else return}});var t=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];h.each(t,function(a){q.prototype[a]=function(){var b=e.call(arguments);return b.unshift(this.models),h[a].apply(h,b)}});var u=["groupBy","countBy","sortBy"];h.each(u,function(a){q.prototype[a]=function(b,c){var d=h.isFunction(b)?b:function(a){return a.get(b)};return h[a](this.models,d,c)}});var v=g.View=function(a){this.cid=h.uniqueId("view"),this._configure(a||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,x=["model","collection","el","id","attributes","className","tagName","events"];h.extend(v.prototype,i,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(a,b){return this.$el&&this.undelegateEvents(),this.$el=a instanceof g.$?a:g.$(a),this.el=this.$el[0],b!==!1&&this.delegateEvents(),this},delegateEvents:function(a){if(!a&&!(a=h.result(this,"events")))return this;this.undelegateEvents();for(var b in a){var c=a[b];h.isFunction(c)||(c=this[a[b]]);if(!c)continue;var d=b.match(w),e=d[1],f=d[2];c=h.bind(c,this),e+=".delegateEvents"+this.cid,f===""?this.$el.on(e,c):this.$el.on(e,f,c)}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(a){this.options&&(a=h.extend({},h.result(this,"options"),a)),h.extend(this,h.pick(a,x)),this.options=a},_ensureElement:function(){if(!this.el){var a=h.extend({},h.result(this,"attributes"));this.id&&(a.id=h.result(this,"id")),this.className&&(a["class"]=h.result(this,"className"));var b=g.$("<"+h.result(this,"tagName")+">").attr(a);this.setElement(b,!1)}else this.setElement(h.result(this,"el"),!1)}}),g.sync=function(a,b,c){var d=y[a];h.defaults(c||(c={}),{emulateHTTP:g.emulateHTTP,emulateJSON:g.emulateJSON});var e={type:d,dataType:"json"};c.url||(e.url=h.result(b,"url")||K()),c.data==null&&b&&(a==="create"||a==="update"||a==="patch")&&(e.contentType="application/json",e.data=JSON.stringify(c.attrs||b.toJSON(c))),c.emulateJSON&&(e.contentType="application/x-www-form-urlencoded",e.data=e.data?{model:e.data}:{});if(c.emulateHTTP&&(d==="PUT"||d==="DELETE"||d==="PATCH")){e.type="POST",c.emulateJSON&&(e.data._method=d);var f=c.beforeSend;c.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",d);if(f)return f.apply(this,arguments)}}e.type!=="GET"&&!c.emulateJSON&&(e.processData=!1),e.type==="PATCH"&&window.ActiveXObject&&(!window.external||!window.external.msActiveXFilteringEnabled)&&(e.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var i=c.xhr=g.ajax(h.extend(e,c));return b.trigger("request",b,i,c),i};var y={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};g.ajax=function(){return g.$.ajax.apply(g.$,arguments)};var z=g.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},A=/\((.*?)\)/g,B=/(\(\?)?:\w+/g,C=/\*\w+/g,D=/[\-{}\[\]+?.,\\\^$|#\s]/g;h.extend(z.prototype,i,{initialize:function(){},route:function(a,b,c){h.isRegExp(a)||(a=this._routeToRegExp(a)),h.isFunction(b)&&(c=b,b=""),c||(c=this[b]);var d=this;return g.history.route(a,function(e){var f=d._extractParameters(a,e);c&&c.apply(d,f),d.trigger.apply(d,["route:"+b].concat(f)),d.trigger("route",b,f),g.history.trigger("route",d,b,f)}),this},navigate:function(a,b){return g.history.navigate(a,b),this},_bindRoutes:function(){if(!this.routes)return;this.routes=h.result(this,"routes");var a,b=h.keys(this.routes);while((a=b.pop())!=null)this.route(a,this.routes[a])},_routeToRegExp:function(a){return a=a.replace(D,"\\$&").replace(A,"(?:$1)?").replace(B,function(a,b){return b?a:"([^/]+)"}).replace(C,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){var c=a.exec(b).slice(1);return h.map(c,function(a){return a?decodeURIComponent(a):null})}});var E=g.History=function(){this.handlers=[],h.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},F=/^[#\/]|\s+$/g,G=/^\/+|\/+$/g,H=/msie [\w.]+/,I=/\/$/;E.started=!1,h.extend(E.prototype,i,{interval:50,getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(a==null)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(I,"");a.indexOf(c)||(a=a.substr(c.length))}else a=this.getHash();return a.replace(F,"")},start:function(a){if(E.started)throw new Error("Backbone.history has already been started");E.started=!0,this.options=h.extend({},{root:"/"},this.options,a),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var b=this.getFragment(),c=document.documentMode,d=H.exec(navigator.userAgent.toLowerCase())&&(!c||c<=7);this.root=("/"+this.root+"/").replace(G,"/"),d&&this._wantsHashChange&&(this.iframe=g.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(b)),this._hasPushState?g.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!d?g.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=b;var e=this.location,f=e.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!f)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&f&&e.hash&&(this.fragment=this.getHash().replace(F,""),this.history.replaceState({},document.title,this.root+this.fragment+e.search));if(!this.options.silent)return this.loadUrl()},stop:function(){g.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),E.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){var b=this.getFragment();b===this.fragment&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe)));if(b===this.fragment)return!1;this.iframe&&this.navigate(b),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a),c=h.any(this.handlers,function(a){if(a.route.test(b))return a.callback(b),!0});return c},navigate:function(a,b){if(!E.started)return!1;if(!b||b===!0)b={trigger:b};a=this.getFragment(a||"");if(this.fragment===a)return;this.fragment=a;var c=this.root+a;if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else if(this._wantsHashChange)this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace));else return this.location.assign(c);b.trigger&&this.loadUrl(a)},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b}}),g.history=new E;var J=function(a,b){var c=this,d;a&&h.has(a,"constructor")?d=a.constructor:d=function(){return c.apply(this,arguments)},h.extend(d,c,b);var e=function(){this.constructor=d};return e.prototype=c.prototype,d.prototype=new e,a&&h.extend(d.prototype,a),d.__super__=c.prototype,d};n.extend=q.extend=z.extend=v.extend=E.extend=J;var K=function(){throw new Error('A "url" property or function must be specified')},L=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}}}.call(this),function(){function c(){return((1+Math.random())*65536|0).toString(16).substring(1)}function d(){return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()}var a=this._,b=this.Backbone;b.LocalStorage=window.Store=function(a){this.name=a;var b=this.localStorage().getItem(this.name);this.records=b&&b.split(",")||[]},a.extend(b.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){return a.id||(a.id=d(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),a},update:function(b){return this.localStorage().setItem(this.name+"-"+b.id,JSON.stringify(b)),a.include(this.records,b.id.toString())||this.records.push(b.id.toString()),this.save(),b},find:function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a.id))},findAll:function(){return a(this.records).chain().map(function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a))},this).compact().value()},destroy:function(b){return this.localStorage().removeItem(this.name+"-"+b.id),this.records=a.reject(this.records,function(a){return a==b.id.toString()}),this.save(),b},localStorage:function(){return localStorage}}),b.LocalStorage.sync=window.Store.sync=b.localSync=function(a,b,c,d){var e=b.localStorage||b.collection.localStorage;typeof c=="function"&&(c={success:c,error:d});var f;switch(a){case"read":f=b.id!=undefined?e.find(b):e.findAll();break;case"create":f=e.create(b);break;case"update":f=e.update(b);break;case"delete":f=e.destroy(b)}f?c.success(f):c.error("Record not found")},b.ajaxSync=b.sync,b.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?b.localSync:b.ajaxSync},b.sync=function(a,c,d,e){return b.getSyncMethod(c).apply(this,[a,c,d,e])}}(),function(){function m(a,b,c){if(a.addEventListener)return a.addEventListener(b,c,!1);a.attachEvent("on"+b,c)}function n(c){return c.type=="keypress"?String.fromCharCode(c.which):a[c.which]?a[c.which]:b[c.which]?b[c.which]:String.fromCharCode(c.which).toLowerCase()}function o(a){var b=a.target||a.srcElement,c=b.tagName;return(" "+b.className+" ").indexOf(" mousetrap ")>-1?!1:c=="INPUT"||c=="SELECT"||c=="TEXTAREA"||b.contentEditable&&b.contentEditable=="true"}function p(a,b){return a.sort().join(",")===b.sort().join(",")}function q(a){a=a||{};var b=!1,c;for(c in h){if(a[c]){b=!0;continue}h[c]=0}b||(k=!1)}function r(a,b,c,d,e){var g,i,j=[],k=c.type;if(!f[a])return[];k=="keyup"&&w(a)&&(b=[a]);for(g=0;g<f[a].length;++g){i=f[a][g];if(i.seq&&h[i.seq]!=i.level)continue;if(k!=i.action)continue;if(k=="keypress"&&!c.metaKey&&!c.ctrlKey||p(b,i.modifiers))d&&i.combo==e&&f[a].splice(g,1),j.push(i)}return j}function s(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function t(a,b){a(b)===!1&&(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),b.returnValue=!1,b.cancelBubble=!0)}function u(a,b){if(o(b))return;var c=r(a,s(b),b),d,e={},f=!1;for(d=0;d<c.length;++d){if(c[d].seq){f=!0,e[c[d].seq]=1,t(c[d].callback,b);continue}!f&&!k&&t(c[d].callback,b)}b.type==k&&!w(a)&&q(e)}function v(a){a.which=typeof a.which=="number"?a.which:a.keyCode;var b=n(a);if(!b)return;if(a.type=="keyup"&&j==b){j=!1;return}u(b,a)}function w(a){return a=="shift"||a=="ctrl"||a=="alt"||a=="meta"}function x(){clearTimeout(i),i=setTimeout(q,1e3)}function y(){if(!e){e={};for(var b in a){if(b>95&&b<112)continue;a.hasOwnProperty(b)&&(e[a[b]]=b)}}return e}function z(a,b,c){return c||(c=y()[a]?"keydown":"keypress"),c=="keypress"&&b.length&&(c="keydown"),c}function A(a,b,c,d){h[a]=0,d||(d=z(b[0],[]));var e=function(b){k=d,++h[a],x()},f=function(a){t(c,a),d!=="keyup"&&(j=n(a)),setTimeout(q,10)},g;for(g=0;g<b.length;++g)B(b[g],g<b.length-1?e:f,d,a,g)}function B(a,b,e,g,h){a=a.replace(/\s+/g," ");var i=a.split(" "),j,k,l,m=[];if(i.length>1)return A(a,i,b,e);l=a==="+"?["+"]:a.split("+");for(j=0;j<l.length;++j)k=l[j],d[k]&&(k=d[k]),e&&e!="keypress"&&c[k]&&(k=c[k],m.push("shift")),w(k)&&m.push(k);e=z(k,m,e),f[k]||(f[k]=[]),r(k,m,{type:e},!g,a),f[k][g?"unshift":"push"]({callback:b,modifiers:m,action:e,seq:g,level:h,combo:a})}function C(a,b,c){for(var d=0;d<a.length;++d)B(a[d],b,c)}var a={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},b={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},c={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},d={option:"alt",command:"meta","return":"enter",escape:"esc"},e,f={},g={},h={},i,j=!1,k=!1;for(var l=1;l<20;++l)a[111+l]="f"+l;for(l=0;l<=9;++l)a[l+96]=l;m(document,"keypress",v),m(document,"keydown",v),m(document,"keyup",v);var D={bind:function(a,b,c){return C(a instanceof Array?a:[a],b,c),g[a+":"+c]=b,this},unbind:function(a,b){return g[a+":"+b]&&(delete g[a+":"+b],this.bind(a,function(){},b)),this},trigger:function(a,b){return g[a+":"+b](),this},reset:function(){return f={},g={},this}};window.Mousetrap=D,typeof define=="function"&&define.amd&&define("mousetrap",function(){return D})}(),$(function(){var a='<div class="showpanel"><button class="button show-load icon-folder-open">app</button></div><div class="panel"><div class="choosepanel"><button class="button show-load icon-folder-open">app</button><button class="button close icon-cancel" title="close menu"></button></div><div class="menu menu-load"><div class="controls"><form class="loadfromgist"><input class="loadfromgistinput" name="loadfromgistinput" placeholder="load app from gist url" type="text" /><button class="loadfromgistsubmit icon-ok" type="submit">load</button></form></div><div class="listing"><button class="button newblank icon-doc" title="new blank app">new</button><div class="currentapp"></div><div class="localapps"><h1>Saved Apps</h1></div><div class="examples"><h1>Examples</h1></div></div></div></div>',b='<h1>Current App</h1><div class="info"><h2 title="url, click to edit" class="seturl editable"></h2><p title="title, click to edit" class="settitle editable"></p><p title="description, click to edit" class="setdescription editable"></p></div><div class="savecontrols"><button class="savelocal icon-install">save local</button><button class="forklocal icon-split" title="save as... copy app and save under a new name">fork</button><button class="savegist icon-globe-1" title="save app to gist.github.com anonymously">save public</button><button class="deletelocal icon-trash" title="delete local app"></button></div><div class="permalink" title="last publicly saved version"></div>',c=Backbone.View.extend({tagName:"div",className:"app",template:_.template(a),currentTemplate:_.template(b),frameCount:0,NativeNodes:{},plugins:{},events:{"click .close":"closePanels","click .show-load":"showLoad","click .newblank":"newBlank","submit .loadfromgist":"loadFromGist","click .savegist":"saveGist","click .savelocal":"saveLocal","click .forklocal":"forkLocal","click .deletelocal":"deleteLocal","blur .settitle":"setTitle","blur .setdescription":"setDescription","blur .seturl":"setUrl"},initialize:function(){this.render(),$("body").prepend(this.el),this.closePanels(),this.once("allLoaded",this.loadLocalApps,this)},allLoaded:function(){this.trigger("allLoaded")},render:function(){return this.$el.html(this.template()),this},shownGraph:null,wireColors:["#FF9292","#00C2EE","#DCA761","#8BB0FF","#96BD6D","#E797D7","#29C6AD"],wireColorIndex:0,selectedPort:null,getWireColor:function(){var a=this.wireColors[this.wireColorIndex];return this.wireColorIndex++,this.wireColorIndex>this.wireColors.length-1&&(this.wireColorIndex=0),a},addMenu:function(a,b,c){var d=this,e=$('<div class="menu menu-'+a+'"></div>').append(b).hide();this.$(".panel").append(e);var f=$('<button class="button show-'+a+'">'+a+"</button>").click(function(){d.showPanel(a)});c&&f.addClass(c),this.$(".showpanel").append(f),this.$(".choosepanel > .close").before(f.clone(!0))},addMenuSection:function(a,b,c){},loadGraph:function(a){this.shownGraph&&(this.shownGraph.remove(),this.shownGraph=null),this.wireColorIndex=0,this.shownGraph=new Iframework.Graph(a),a.info.title&&(document.title="Meemoo: "+a.info.title),this.updateCurrentInfo()},gotMessage:function(a){if(Iframework.shownGraph){var b=Iframework.shownGraph.get("nodes").get(a.data.nodeid);if(b)for(var c in a.data)if(a.data.hasOwnProperty(c)){var d=a.data[c];switch(c){case"message":b.sendFromFrame(d);break;case"info":b.infoLoaded(d);break;case"addInput":b.addInput(d);break;case"addOutput":b.addOutput(d);break;case"stateReady":b.iframeLoaded();break;case"set":b.setValues(d);break;default:}}}},_exampleGraphs:[],_loadedExample:null,loadExampleApps:function(a){this._exampleGraphs=this._exampleGraphs.concat(a);var b="";for(var c=0;c<a.length;c++){var d=a[c].info.url;d&&(b+='<a href="#example/'+d+'" title="'+a[c].info.title+": "+a[c].info.description+'">'+d+"</a> <br />")}this.$(".menu-load .examples").append(b),this.shownGraph||(this._loadedExample?this.loadExample(this._loadedExample):!this._loadedLocal&&!this._loadedLocal&&!this._loadedGist&&this.newBlank())},loadExample:function(a){this._loadedExample=a;for(var b=0;b<this._exampleGraphs.length;b++)if(this._exampleGraphs[b].info.url===a)return this._loadedLocalApp=null,this.loadGraph(this._exampleGraphs[b]),this.analyze("load","example",a),!0},closePanels:function(){this.$(".showpanel").show(),this.$(".panel").hide(),this.$(".graph").css("right","0px"),this.$(".menu").hide()},showPanel:function(a){this.$(".menu").hide(),this.$(".showpanel").hide(),this.$(".panel").show(),this.$(".graph").css("right","350px"),a&&(this.$(".menu-"+a).show(),this.trigger("showmenu:"+a))},showLoad:function(){this.showPanel(),this.$(".menu-load").show()},loadFromGist:function(){var a=this.loadFromGistId(this.$(".loadfromgistinput").val());return a&&($(".loadfromgistinput").blur(),this.router&&this.router.navigate("gist/"+a),this.$(".loadfromgistinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".loadfromgistinput").attr("placeholder","load app from gist url")},1500)),!1},loadFromGistId:function(a){this._loadedGist=a;var b=a.split("/");return b.length>3&&b[2]==="gist.github.com"&&(a=b[b.length-1]),$.ajax({url:"https://api.github.com/gists/"+a,type:"GET",dataType:"jsonp"}).success(function(a){var b=[];for(var c in a.data.files)if(a.data.files.hasOwnProperty(c)){var d=JSON.parse(a.data.files[c].content);if(d){var e=a.data.html_url;if(!d.info.parents||!d.info.parents.push)d.info.parents=[];d.info.parents.indexOf(e)===-1&&d.info.parents.push(e),b.push(d)}}b.length>0&&(Iframework.loadGraph(b[0]),Iframework.closePanels())}).error(function(a){console.warn("gist load error",a)}),this.analyze("load","gist",a),a},saveGist:function(){var a=this.shownGraph.toJSON(),b={description:"meemoo app: "+a.info.title,"public":!0};b.files={};var c=a.info.url+".json";b.files[c]={content:JSON.stringify(a,null,"  ")},this.$(".savegist").prop("disabled",!0).text("saving..."),$.ajax({url:"https://api.github.com/gists",type:"POST",dataType:"json",data:JSON.stringify(b)}).success(function(b){var c=Iframework.shownGraph.get("info");if(!c.hasOwnProperty("parents")||!c.parents.push)a.info.parents=[];a.info.parents.push(b.html_url),Iframework.saveLocal(),Iframework.updateCurrentInfo(),Iframework.analyze("save","gist",b.id)}).error(function(a){var b="meemoo app: "+Iframework.shownGraph.toJSON().info.title;Iframework.$(".permalink").html('api is down (;_;) copy your app source code to <a href="https://gist.github.com/?description='+encodeURIComponent(b)+'" target="_blank">gist.github.com</a>'),console.warn("gist save error",a)}).complete(function(a){this.$(".savegist").prop("disabled",!1).text("save public")})},loadLocalApps:function(){this._localApps=new Iframework.LocalApps,this._localApps.fetch({success:function(a){Iframework._localApps.each(function(a){a.initializeView()}),Iframework.shownGraph||Iframework._loadedLocal&&Iframework.loadLocal(Iframework._loadedLocal)},error:function(a){console.warn("error loading local apps")}})},_loadedLocal:null,_loadedLocalApp:null,loadLocal:function(a){this._loadedLocal=a;if(this._localApps){var b=this._localApps.getByUrl(a);return b?(b.load(),!0):(console.warn("Didn't find local app with matching url."),this.newBlank(),!1)}return!1},setKey:function(a){var b=window.prompt("Enter a url key",a);return b&&(b=this.encodeKey(b),this.shownGraph.setInfo("url",b)),b},encodeKey:function(a){return a=a.toLowerCase().replace(/ /g,"-"),a=encodeURIComponent(a),a},saveLocal:function(){this.shownGraph.get("info")||this.shownGraph.set({info:{}});while(!this.shownGraph.get("info").hasOwnProperty("url")||this.shownGraph.get("info").url===""){var a;this.shownGraph.get("info").hasOwnProperty("title")&&this.shownGraph.get("info").title!==""?a=this.shownGraph.get("info").title:a="app-"+(new Date).getTime();if(!this.setKey(a))return!1}var b=JSON.parse(JSON.stringify(this.shownGraph)),c=b.info.url,d;if(this._loadedLocalApp)if(this._localApps.getByUrl(c)&&this._localApps.getByUrl(c)!==this._loadedLocalApp)if(window.confirm('"'+c+'" already exists as a local app. Do you want to replace it?'))d=this._localApps.updateOrCreate(b);else return!1;else d=this._loadedLocalApp,d.save({graph:b}),d.trigger("change");else{if(this._localApps.getByUrl(c)&&!window.confirm('"'+c+'" already exists as a local app. Do you want to replace it?'))return!1;d=this._localApps.updateOrCreate(b)}return this._loadedLocalApp=d,this.analyze("save","local","x"),this.updateCurrentInfo(),Iframework.router.navigate("local/"+c),d},forkLocal:function(){this._loadedLocalApp=null;var a=this.shownGraph.get("info").url+"-copy";this.setKey(a),this.saveLocal()},deleteLocal:function(){this._loadedLocalApp&&(this._loadedLocalApp.destroy(),this._loadedLocalApp=null)},setTitle:function(){var a=this.$(".currentapp .info .settitle").text();a!==this.shownGraph.get("info").title&&this.shownGraph.setInfo("title",a)},setDescription:function(){var a=this.$(".currentapp .info .setdescription").text();a!==this.shownGraph.get("info").description&&this.shownGraph.setInfo("description",a)},setUrl:function(){var a=this.$(".currentapp .info .seturl").text();a=this.encodeKey(a),a!==this.shownGraph.get("info").url&&this.shownGraph.setInfo("url",a)},_enableKeyBindings:!0,updateCurrentInfo:function(){var a=this.shownGraph.toJSON();this.$(".currentapp").html(this.currentTemplate(a)),this.$(".currentapp .seturl").text(decodeURIComponent(a.info.url)),this.$(".currentapp .settitle").text(a.info.title),this.$(".currentapp .setdescription").text(a.info.description),this.$(".editable").attr("contenteditable","true");if(a.info.hasOwnProperty("parents")){var b=a.info.parents;if(b.length>0){var c=b[b.length-1],d=c.split("/");if(d.length>0){var e=d[d.length-1],f="http://meemoo.org/iframework/#gist/"+e,g=encodeURIComponent(f),h=encodeURIComponent(a.info.title),i=$("<span />").text(f).click(function(a){Iframework._enableKeyBindings=!1;var b;if(document.body.createTextRange)b=document.body.createTextRange(),b.moveToElementText(a.target),b.select();else if(window.getSelection){var c=window.getSelection();b=document.createRange(),b.selectNodeContents(a.target),c.removeAllRanges(),c.addRange(b)}}),j=$('<a title="your saved gist" target="_blank" class="share icon-github"></a>').attr("href",c),k=$('<a title="share on facebook" target="_blank" class="share icon-facebook-rect"></a>').attr("href","https://www.facebook.com/sharer.php?u="+g+"&t="+h),l=" "+a.info.title+" #meemoo "+a.info.description;l.length>=120&&(l=l.substr(0,115)+"..."),l=f+l;var m=$('<a title="post to twitter" target="_blank" class="share icon-twitter-bird"></a>').attr("href","https://twitter.com/intent/tweet?text="+encodeURIComponent(l));this.$(".currentapp .permalink").empty().append(i).append(" ").append(j).append(" ").append(k).append(m)}}}this._loadedLocalApp?this.$(".currentapp .deletelocal").show():this.$(".currentapp .deletelocal").hide()},newBlank:function(){this.loadGraph({info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]}),this._loadedLocalApp=null,this.showPanel("library"),Iframework.router.navigate("new")},analyze:function(a,b,c){}});window.Iframework=new c,window.addEventListener("message",Iframework.gotMessage,!1)}),$(function(){Iframework.util={types:{"undefined":"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error","[object HTMLCanvasElement]":"HTMLCanvasElement","[object ImageData]":"ImageData"},type:function(a){return this.types[typeof a]||this.types[Object.prototype.toString.call(a)]||(a?"object":"null")},imageTypes:["png","gif","jpg","jpeg","webp"],isImageURL:function(a){var b=a.split(".");if(b.length>1){var c=b[b.length-1];return this.imageTypes.indexOf(c)>-1}return!1}},window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()}),$(function(){Iframework.Event=Backbone.Model.extend({defaults:function(){return{action:"",args:{}}},initialize:function(){}}),Iframework.EventsHistory=Backbone.Collection.extend({model:Iframework.Event}),Mousetrap.bind(["command+z","ctrl+z"],function(a){var b=window.Iframework.shownGraph,c=b.eventsHistory.last();if(c.get("action")==="removeNode"){var d=c.get("args").node,e=b.usedIds.indexOf(d.get("id"));b.usedIds.splice(e,1),b.addNode(d);var f;for(f=0;f<d.Inputs.length;f++)d.view.addInput(d.Inputs.at(f));for(f=0;f<d.Outputs.length;f++)d.view.addOutput(d.Outputs.at(f));var g=c.get("args").edges;for(f=0;f<g.length;f++)b.addEdge(g[f])}b.eventsHistory.pop()})}),$(function(){Iframework.LocalApp=Backbone.Model.extend({initializeView:function(){return this.view||(this.view=new Iframework.LocalAppView({model:this})),this.view},load:function(){Iframework._loadedLocalApp=this;var a=JSON.parse(JSON.stringify(this.get("graph")));Iframework.loadGraph(a)},toJSON:function(){return{id:this.id,graph:this.get("graph")}}}),Iframework.LocalApps=Backbone.Collection.extend({model:Iframework.LocalApp,localStorage:new Backbone.LocalStorage("LocalApps"),getByUrl:function(a){var b=this.find(function(b){return b.get("graph").info.url===a});return b},updateOrCreate:function(a){var b;return b=this.find(function(b){return b.get("graph").info.url===a.info.url}),b?(b.save({graph:a}),b.trigger("change")):(b=this.create({graph:a}),b.initializeView()),b}})}),$(function(){var a='<a class="url" href="#local/<%= graph.info.url %>"></a><div class="info"><h2 class="title"><%= graph.info.title %></h2><p class="description"><%= graph.info.description %></p></div>';Iframework.LocalAppView=Backbone.View.extend({tagName:"div",className:"localapp",template:_.template(a),events:{},initialize:function(){return this.render(),Iframework.$(".localapps").append(this.el),this.model.on("change",this.update,this),this.model.on("destroy",this.remove,this),this},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".url").text(decodeURIComponent(this.model.get("graph").info.url)),this.$(".info").hide()},update:function(){this.render(),Iframework.updateCurrentInfo()},remove:function(){this.$el.remove()}})}),$(function(){Iframework.Graph=Backbone.Model.extend({loaded:!1,defaults:{info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]},usedIds:[],edgeCount:0,eventsHistory:[],initialize:function(){this.usedIds=[];if(this.attributes.nodes){var a=this.attributes.nodes;this.attributes.nodes=new Iframework.Nodes;for(var b=0;b<a.length;b++){var c=this.makeNode(a[b]);c&&this.addNode(c)}}if(this.attributes.edges){var d=this.attributes.edges;this.attributes.edges=new Iframework.Edges;for(var e=0;e<d.length;e++){var f=new Iframework.Edge(d[e]);f.graph=this,this.addEdge(f)}}this.eventsHistory=new Iframework.EventsHistory,_.defer(function(){Iframework.shownGraph.testLoaded()}),this.on("change",this.graphChanged)},testLoaded:function(){var a=!0;return this.get("nodes").each(function(b){b.hasOwnProperty("lazyLoadType")&&(Iframework.NativeNodes.hasOwnProperty(b.lazyLoadType)?b.view&&!b.Native&&b.view.initializeNative():a=!1)},this),a&&this.initializeView(),a},initializeView:function(){this.view||(this.view=new Iframework.GraphView({model:this}))},setInfo:function(a,b){var c=this.get("info");c[a]=b,this.trigger("change")},makeNode:function(a){if(!a.src)return!1;var b;if(Iframework.util.isImageURL(a.src)){var c=a.src;a.src="meemoo:image/in",a.state||(a.state={}),a.state.url=c}var d=a.src.split(":");if(d.length<2)return!1;if(d[0]==="meemoo"){var e=d[d.length-1],f=e.split("/");e=f.join("-"),f[0]&&f[1]&&yepnope([{test:Iframework.NativeNodes.hasOwnProperty(f[0]),nope:"src/nodes/"+f[0]+".js"},{test:Iframework.NativeNodes.hasOwnProperty(f[0]+"-"+f[1]),nope:"src/nodes/"+f[0]+"-"+f[1]+".js",complete:function(){_.defer(function(){Iframework.shownGraph.testLoaded()})}}]),b=new Iframework.NodeBox(a),b.lazyLoadType=e}else b=new Iframework.NodeBoxIframe(a);return b},addNode:function(a){if(!a.cid){a=this.makeNode(a);if(!a)return!1}a.graph=this;var b=this.get("nodes").length,c=parseInt(a.get("id"),10);c!==c&&a.set({id:b});while(this.usedIds.indexOf(a.get("id"))>=0)b++,a.set({id:b});this.usedIds.push(a.get("id"));var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(var f=0;f<5;f++)e+=d.charAt(Math.floor(Math.random()*d.length));return a.frameIndex="frame_"+a.get("id")+"_"+Iframework.frameCount++ +e+"_through",this.get("nodes").add(a),this.view&&this.view.addNode(a),this.trigger("change"),a},addEdge:function(a){var b=this.get("edges").any(function(b){return b.get("source")[0]===a.get("source")[0]&&b.get("source")[1]===a.get("source")[1]&&b.get("target")[0]===a.get("target")[0]&&b.get("target")[1]===a.get("target")[1]});return b?(console.warn("duplicate edge ignored",a),!1):(this.trigger("change"),this.get("edges").add(a))},remove:function(){this.get("nodes").each(function(a){a.remove(!1)}),this.view&&this.view.remove()},removeNode:function(a){var b=[];_.each(a.view.relatedEdges(),function(a){b.push(a),a.remove()},this),this.view&&this.view.removeNode(a),this.get("nodes").remove(a),this.eventsHistory.add(new Iframework.Event({action:"removeNode",args:{node:a,edges:b}})),this.trigger("change")},removeEdge:function(a){a.disconnect(),this.get("edges").remove(a),this.view&&this.view.removeEdge(a),this.trigger("change")},checkLoaded:function(){for(var a=0;a<this.get("nodes").length;a++)if(this.get("nodes").at(a).loaded===!1)return!1;this.loaded=!0;var b=this;return setTimeout(function(){b.connectEdges()},500),!0},reconnectEdges:function(){for(var a=0;a<this.get("edges").length;a++)this.get("edges").at(a).disconnect();setTimeout(function(){Iframework.shownGraph.connectEdges()},500)},connectEdges:function(){this.get("edges").each(function(a){a.connected||a.connect()}),this.get("nodes").each(function(a){a.setState()})},graphChanged:function(){Iframework.trigger("change",this)},toJSON:function(){return{info:this.get("info"),nodes:this.get("nodes"),edges:this.get("edges")}}}),Iframework.Graphs=Backbone.Collection.extend({model:Iframework.Graph})}),$(function(){var a='<div class="edges"><svg id="edgesSvg" class="edgesSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg></div><div class="nodes" />';Iframework.GraphView=Backbone.View.extend({tagName:"div",className:"graph",template:_.template(a),events:{click:"click",drop:"drop",selectablestart:"selectableStart",selectablestop:"selectableStop"},initialize:function(){this.render(),Iframework.$el.prepend(this.el),Iframework.$(".panel").is(":visible")&&this.$el.css("right","350px"),this.model.get("nodes").each(this.addNode),this.$el.droppable({accept:".addnode, .canvas, .meemoo-plugin-images-thumbnail"}).selectable({filter:".module",delay:20}),this.resizeEdgeSVG(),window.requestAnimationFrame(this.renderAnimationFrame)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderAnimationFrame:function(a){a=a!==undefined?a:Date.now();var b=Iframework.shownGraph.view;!b||(window.requestAnimationFrame(b.renderAnimationFrame),b.model.get("nodes").each(function(b){b.view.Native&&b.view.Native.renderAnimationFrame(a)}))},click:function(a){$(".edge-edit").remove(),Iframework.selectedPort=null,$("div.module").removeClass("active")},drop:function(a,b){var c=b.helper.data("meemoo-drag-type");if(!c)return!1;var d={x:Math.round(this.$el.scrollLeft()+b.offset.left+10),y:Math.round(this.$el.scrollTop()+b.offset.top+35)};switch(c){case"library-module":var e=b.draggable.data("module");e&&e.view.dragAddNode(d);break;case"canvas":var f=b.helper.data("meemoo-drag-canvas");if(f){d.src="meemoo:image/in",d.canvas=f;var g=b.helper.data("meemoo-image-url");g&&g.slice(0,4)==="http"&&(d.state={},d.state.url=g),Iframework.shownGraph.addNode(d)}break;default:}return!1},addNode:function(a){this.$(".nodes").append(a.initializeView().el),!a.lazyLoadType||a.view.initializeNative()},addEdge:function(a){a.initializeView(),!a.Source.view||a.Source.view.resetRelatedEdges(),!a.Target.view||a.Target.view.resetRelatedEdges()},remove:function(){this.$el.remove()},removeNode:function(a){a.view&&a.view.remove()},removeEdge:function(a){a.Source&&a.Source.view&&a.Source.view.resetRelatedEdges(),a.Target&&a.Target.view&&a.Target.view.resetRelatedEdges(),a.view&&a.view.remove()},resizeEdgeSVG:function(){var a=0,b=0;this.model.get("nodes").each(function(c){var d=c.get("x")+c.get("w");d>a&&(a=d);var e=c.get("y")+c.get("h");e>b&&(b=e)},this),a+=150,b+=50,a===150&&b===50&&(a=this.$el.width(),b=this.$el.height()),this.$("#edgesSvg").css({width:a,height:b})},selectableStart:function(){this.maskFrames()},_selected:[],selectableStop:function(a){a&&this.unmaskFrames(),this._selected=[];var b=$(".module.ui-selected");for(var c=0;c<b.length;c++)this._selected.push({el:b[c],offset:$(b[c]).offset(),view:$(b[c]).data("view")});Iframework._enableKeyBindings=!0},selectAll:function(){$(".module").addClass("ui-selected"),this.selectableStop()},selectNone:function(){$(".module").removeClass("ui-selected"),this.selectableStop()},cut:function(){this.copy();var a;for(a=0;a<Iframework._copied.nodes.length;a++)Iframework._copied.nodes[a].x-=50,Iframework._copied.nodes[a].y-=50;for(a=0;a<this._selected.length;a++)this._selected[a].view.removeModel();this.selectableStop()},copy:function(){var a={nodes:[],edges:[]};for(var b=0;b<this._selected.length;b++){var c=this._selected[b].view.model.toJSON();a.nodes.push(JSON.parse(JSON.stringify(c)))}this.model.get("edges").each(function(c){var d,e=!1;for(b=0;b<this._selected.length;b++)c.Source.node===this._selected[b].view.model&&(d=!0),c.Target.node===this._selected[b].view.model&&(e=!0);d&&e&&a.edges.push(c.toJSON())},this),Iframework._copied=a},paste:function(){var a=Iframework._copied;if(a&&a.nodes.length>0){var b=[];$(".module").removeClass("ui-selected");for(var c=0;c<a.nodes.length;c++){var d=a.nodes[c];d.x+=50,d.y+=50;var e=this.model.addNode(d);e.copiedFrom=d.id,b.push(e),e.view&&e.view.select()}this.selectableStop();for(var f=0;f<a.edges.length;f++){var g=a.edges[f],h={source:[],target:[]};for(var i=0;i<b.length;i++){var j=b[i];g.source[0]===j.copiedFrom&&(h.source[0]=j.id),g.target[0]===j.copiedFrom&&(h.target[0]=j.id)}h.source[1]=g.source[1],h.target[1]=g.target[1],h=new Iframework.Edge(h),h.graph=this.model,this.model.addEdge(h)}}},maskFrames:function(){$(".iframe-type").append('<div class="iframemask" />')},unmaskFrames:function(){$(".iframemask").remove()}})}),$(function(){Iframework.Node=Backbone.Model.extend({send:function(a){},receive:function(a){},sendFromFrame:function(){},iframeLoaded:function(){}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeView=Backbone.View.extend({send:function(a){this.model.send(a)},receive:function(a){this.model.receive(a)}})}),$(function(){Iframework.NodeBox=Iframework.Node.extend({loaded:!1,defaults:function(){return{src:"",x:100,y:400,z:0,w:200,h:210,state:{}}},info:{title:"native-node",description:"extend me"},initialize:function(){this.Inputs=new Iframework.PortsIn,this.Outputs=new Iframework.PortsOut,this.on("change",this.nodeChanged)},initializeView:function(){return this.view=new Iframework.NodeBoxView({model:this}),this.view},send:function(a,b){var c=this.Outputs.get(a);!c||c.send(b)},receive:function(a){for(var b in a)this.view.Native&&this.view.Native.recieve(b,a[b])},infoLoaded:function(a){this.info=a,this.view&&this.view.infoLoaded(a)},setState:function(){var a=this.get("state");if(a&&this.view.Native)for(var b in a)this.view.Native["input"+b]?this.view.Native["input"+b](a[b]):this.view.Native["_"+b]=a[b]},addInput:function(a){a.id=a.name;var b=this.Inputs.get(a.name);if(b){b.set(a);return}var c;a.type==="image"?c=new Iframework.PortInImage(a):c=new Iframework.PortIn(a),c.isIn=!0,c.node=this,c.graph=this.graph,this.Inputs.add(c),this.view&&this.view.addInput(c);var d=this.get("state");a.hasOwnProperty("default")&&a["default"]!==""&&!d.hasOwnProperty(a.name)&&(d[a.name]=a["default"])},addOutput:function(a){a.id=a.name;var b=this.Outputs.get(a.name);if(b){b.set(a);return}var c;a.type==="image"?c=new Iframework.PortOutImage(a):c=new Iframework.PortOut(a),c.isIn=!1,c.node=this,c.graph=this.graph,this.Outputs.add(c),this.view&&this.view.addOutput(c)},nodeChanged:function(){this.graph&&this.graph.trigger("change")},remove:function(a){a?this.graph.removeNode(this):this.view&&this.view.remove()},setValues:function(a){for(var b in a)this.get("state")[b]=a[b];this.nodeChanged()},setValue:function(a,b){this.get("state")[a]=b,this.nodeChanged()},toString:function(){return this.info?"Native node "+this.get("id")+": "+this.info.title:"Native node "+this.get("id")},toJSON:function(){return{id:this.id,src:this.get("src"),x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h"),state:this.get("state")}}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var a='<div class="module" style="left:<%= get("x")-10 %>px;top:<%= get("y")-30 %>px;width:<%= get("w")+20 %>px;height:<%= get("h")+40 %>px;" ><div class="outer"></div><div class="ports ports-in"></div><div class="ports ports-out"></div><h1 class="title">...</h1><button type="button" class="showcontrols">show controls</button><div class="controls"><button type="button" class="remove">remove</button><button type="button" class="hidecontrols">hide controls</button></div><div class="inner"></div></div>';Iframework.NodeBoxView=Iframework.NodeView.extend({tagName:"div",className:"node",template:_.template(a),events:{"dragstart .module":"dragstart","drag .module":"drag","dragstop .module":"dragstop","resizestart .module":"resizestart","resize .module":"resize","resizestop .module":"resizestop","mousedown .module, .title":"mousedown","click .module, .title":"click","click .showcontrols":"showControls","click .hidecontrols":"hideControls","click .remove":"removeModel"},initialize:function(){this.render(),this.$(".module").data({view:this}).draggable({handle:"h1"}).resizable({minHeight:100,minWidth:100}),this.$(".showcontrols").button({icons:{primary:"icon-left-open"},text:!1}),this.$(".hidecontrols").button({icons:{primary:"icon-right-open"},text:!1}),this.$(".remove").button({icons:{primary:"icon-trash"},text:!1}),this.$("h1").disableSelection(),this.mousedown()},initializeNative:function(){this.Native||Iframework.NativeNodes.hasOwnProperty(this.model.lazyLoadType)&&(this.Native=new Iframework.NativeNodes[this.model.lazyLoadType]({model:this.model}),this.$(".inner").append(this.Native.$el),this.model.loaded=!0,this.model.graph.checkLoaded())},render:function(){return this.$el.html(this.template(this.model)),this},infoLoaded:function(a){this.$("h1").text(this.model.get("id")+": "+a.title).attr({title:(a.author?"by "+a.author+": ":"")+a.description})},_relatedEdges:null,relatedEdges:function(){if(this._relatedEdges===null){var a=[];this.model.Inputs.each(function(b){b.Edges.each(function(b){a.push(b)})}),this.model.Outputs.each(function(b){b.Edges.each(function(b){a.push(b)})}),this._relatedEdges=a}return this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},_delta:{},dragstart:function(a,b){this.model.graph.view.maskFrames(),this.$(".module").hasClass("ui-selected")||($("div.module.ui-selected").removeClass("ui-selected"),this.$(".module").addClass("ui-selected")),this.model.graph.view.selectableStop(),this._delta=this.$(".module").offset()},drag:function(a,b){_.each(this.relatedEdges(),function(a){a.view&&a.view.redraw()});if(a&&b){var c=this.model.graph.view._selected,d=this._delta.left-b.offset.left-$(".graph").scrollLeft(),e=this._delta.top-b.offset.top-$(".graph").scrollTop();for(var f=0;f<c.length;f++)this.$(".module")[0]!==c[f].el&&($(c[f].el).css({left:c[f].offset.left-d+"px",top:c[f].offset.top-e+"px"}),c[f].view.drag())}},dragstop:function(a,b){this.drag(),this.model.set({x:this.$(".module").offset().left+10+$(".graph").scrollLeft(),y:this.$(".module").offset().top+30+$(".graph").scrollTop()});if(a){this.model.graph.view.unmaskFrames();var c=this.model.graph.view._selected;for(var d=0;d<c.length;d++)this.$(".module")[0]!==c[d].el&&c[d].view.dragstop();this.model.graph.view.resizeEdgeSVG()}},resizestart:function(a,b){this.model.graph.view.maskFrames()},resize:function(a,b){this.drag()},resizestop:function(a,b){this.model.graph.view.unmaskFrames();var c=b.size.width,d=b.size.height;this.model.set({w:c-20,h:d-40}),this.Native&&this.Native.resize(c,d),this.model.graph.view.resizeEdgeSVG(),this.drag()},mousedown:function(a,b){var c=0;$("div.module").each(function(){var a=Number($(this).css("z-index"));a>c&&(c=a)}),this.$(".module").css("z-index",c+1),a&&a.stopPropagation()},click:function(a){a.ctrlKey||a.metaKey?this.$(".module").hasClass("ui-selected")?this.$(".module").removeClass("ui-selected"):this.select():($("div.module.ui-selected").removeClass("ui-selected"),this.select()),this.model.graph.view&&this.model.graph.view.selectableStop(),a.stopPropagation()},select:function(){this.$(".module").addClass("ui-selected")},addInput:function(a){this.$(".ports-in").append(a.initializeView().el)},addOutput:function(a){this.$(".ports-out").append(a.initializeView().el)},showControls:function(){this.$(".showcontrols").hide(),this.$(".controls").show()},hideControls:function(){this.$(".showcontrols").show(),this.$(".controls").hide()},removeModel:function(){this.model.remove(!0)},remove:function(){this.Native&&this.Native.remove(),this.$el.remove()},refresh:function(){},popout:function(){}})}),$(function(){var a='<div class="info" />';Iframework.NodeBoxNativeView=Backbone.View.extend({tagName:"div",className:"nativenode",template:_.template(a),info:{title:"native-node-view",description:"extend me"},inputs:{},outputs:{},initialize:function(){this.render(),this.model.infoLoaded(this.info);for(var a in this.inputs)if(this.inputs.hasOwnProperty(a)){var b=this.inputs[a];b.name=a,this.model.addInput(b)}for(var c in this.outputs)if(this.outputs.hasOwnProperty(c)){var d=this.outputs[c];d.name=c,this.model.addOutput(d)}return this.initializeCategory(),this.initializeModule(),this},initializeCategory:function(){},initializeModule:function(){},render:function(){return this.$el.html(this.template(this.model)),this},redraw:function(a){},_triggerRedraw:!1,_lastRedraw:0,renderAnimationFrame:function(a){this._triggerRedraw&&(this._triggerRedraw=!1,this.redraw(a),this._lastRedraw=a)},set:function(a,b){this.model.setValue(a,b)},send:function(a,b){this.model.send(a,b)},recieve:function(a,b){this["input"+a]?this["input"+a](b):(this["_"+a]=b,this._triggerRedraw=!0)},toString:function(){return"Native view: "+this.model.get("id")+": "+this.info.title},resize:function(a,b){},connectEdge:function(a){},disconnectEdge:function(a){},remove:function(){}})}),$(function(){Iframework.NodeBoxIframe=Iframework.NodeBox.extend({initializeView:function(){return this.view=new Iframework.NodeBoxIframeView({model:this}),this.view},info:{title:"iframe-node",description:"extend me"},sendFromFrame:function(a){var b=this.Outputs.get(a.output);!b||b.send(a.value)},receive:function(a){window.frames[this.frameIndex]?window.frames[this.frameIndex].postMessage(a,"*"):console.error("wat "+this.id+" "+this.frameIndex)},setState:function(){var a=this.get("state");a&&this.receive({setState:a})},iframeLoaded:function(){this.loaded=!0,this.graph.checkLoaded()},toString:function(){return this.info?"Iframe node "+this.get("id")+": "+this.info.title:"Iframe node "+this.get("id")}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var a='<iframe class="iframe" name="<%= frameIndex %>" src="<%= get("src") %>"></iframe>';Iframework.NodeBoxIframeView=Iframework.NodeBoxView.extend({innerTemplate:_.template(a),initialize:function(){Iframework.NodeBoxView.prototype.initialize.call(this),this.$("button.remove").after($('<button type="button" class="refresh">refresh</button>').button({icons:{primary:"icon-cw"},text:!1})),this.events["click .refresh"]="refresh",this.$(".inner").addClass("iframe-type")},render:function(){return this.$el.html(this.template(this.model)),this.$(".inner").html(this.innerTemplate(this.model)),this},refresh:function(){this.$("iframe")[0].src=this.model.get("src")}})}),$(function(){Iframework.Port=Backbone.Model.extend({defaults:{name:"",type:"",description:"","default":null},initialize:function(){this.get("type")===""&&this.set("type","all"),this.set("type_class",this.get("type").split(":")[0]),this.Edges=new Iframework.Edges},connect:function(a){this.Edges.add(a)},disconnect:function(a){this.Edges.remove(a)}}),Iframework.Ports=Backbone.Collection.extend({model:Iframework.Port})}),$(function(){var a='<div class="edge-edit"><button class="close">close</button><h2><%= name %> (<%= type %>)</h2><p><%= description %></p></div>',b='<div class="edge-edit-item" id="<%= model.cid %>"><span><%= label() %></span><button class="disconnect" type="button">disconnect</button></div>',c={};Iframework.PortView=Backbone.View.extend({tagName:"div",className:"port",popupTemplate:_.template(a),edgeEditTemplate:_.template(b),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},initialize:function(){return this.render(),this},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name");if(Iframework.selectedPort&&c!==Iframework.selectedPort.isIn){var e;c?e=new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):e=new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),e.graph=Iframework.shownGraph,e.graph.addEdge(e)&&e.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=undefined),Iframework.selectedPort=null;return}var f=this.popupTemplate(this.model.toJSON());f=$(f),this.$el.append(f),f.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var g=this.model.get("type").substring(0,3);if(c){var h=!1,i=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if(g==="int"||g==="num"||g==="flo")h=!0,i.append($("<input />").attr({type:"number",min:b.data("min"),max:b.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="col"||g==="str")h=!0,i.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="boo"){h=!0;var j=this.model.node.get("state")[this.model.get("name")];j=Boolean(j)&&j!=="false",i.append($("<input />").attr({type:"checkbox",checked:j}))}else g==="ban"&&(i.append("<label>Send bang:</label> "),h=!0);h&&(i.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),f.append(i))}$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(f.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);f.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(a){var b=this.model.get("name"),c;this.$(".manualinput").children("input")&&(c=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(this.$(".manualinput").children("input:checkbox").is(":checked")?c=!0:c=!1),this.model.get("type")==="int"&&(c=parseInt(c,10));if(this.model.get("type")==="number"||this.model.get("type")==="float")c=parseFloat(c);c===undefined&&(c="!");var d={};return d[b]=c,this.model.node.receive(d),this.model.node.get("state")[b]=c,this.model.node.trigger("change"),!1},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortIn=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this})},receive:function(a){var b={};b[this.id]=a,this.node.receive(b)}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){var a='<div class="portshown portshown-in"><span class="hole hole-in hole-<%= type_class %> icon-login"></span><span class="label"><%= name %></span></div><span class="plugend plugend-in plugend-<%= type_class %>"></span>';Iframework.PortInView=Iframework.PortView.extend({tagName:"div",className:"port",portInTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput"},render:function(){this.$el.html(this.portInTemplate(this.model.toJSON())),this.$el.addClass("port-in"),this.$(".hole").draggable({helper:function(a){return $('<span class="holehelper holehelper-out" />')}}),this.$(".plugend").draggable({helper:function(a){return $('<span class="plugendhelper plugendhelper-in" />')}}),this.$(".hole").data({model:this.model});var a="",b=this.model.get("type_class");b==="all"||b==="bang"?a=".hole-out, .plugend-in":a=".hole-out.hole-all, .hole-out.hole-"+b+", .plugend-in.plugend-all, .plugend-in.plugend-"+b,b==="string"&&(a+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float");if(b==="int"||b==="float"||b==="number")a+=", .hole-out.hole-int, .hole-out.hole-float, .hole-out.hole-number, .plugend-in.plugend-int, .plugend-in.plugend-float, .plugend-in.plugend-number";this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name");if(Iframework.selectedPort&&c!==Iframework.selectedPort.isIn){var e;c?e=new Iframework.Edge({source:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")],target:[this.model.node.get("id"),this.model.get("name")]}):e=new Iframework.Edge({source:[this.model.node.get("id"),this.model.get("name")],target:[Iframework.selectedPort.node.get("id"),Iframework.selectedPort.get("name")]}),e.graph=Iframework.shownGraph,e.graph.addEdge(e)&&e.connect(),Iframework.edgePreview&&(Iframework.shownGraph.view.$(".edges").children(".preview").remove(),Iframework.edgePreview=undefined),Iframework.selectedPort=null;return}var f=this.popupTemplate(this.model.toJSON());f=$(f),this.$el.append(f),f.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var g=this.model.get("type").substring(0,3),h=!1,i=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if(g==="int"||g==="num"||g==="flo")h=!0,i.append($("<input />").attr({type:"number",min:b.data("min"),max:b.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="col"||g==="str")h=!0,i.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if(g==="boo"){h=!0;var j=this.model.node.get("state")[this.model.get("name")];j=Boolean(j)&&j!=="false",i.append($("<input />").attr({type:"checkbox",checked:j}))}else g==="ban"&&(i.append("<label>Send bang:</label> "),h=!0);h&&(i.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),f.append(i)),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(f.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);f.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(a){var b=this.model.get("name"),c,d=!0;this.$(".manualinput").children("input")&&(c=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(this.$(".manualinput").children("input:checkbox").is(":checked")?c=!0:c=!1),this.model.get("type")==="int"&&(c=parseInt(c,10));if(this.model.get("type")==="number"||this.model.get("type")==="float")c=parseFloat(c);c===undefined&&(c="!",d=!1);var e={};return e[b]=c,this.model.node.receive(e),d&&this.model.node.setValue(b,c),!1},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortInImage=Iframework.PortIn.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this})},getCanvas:function(a){this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"));if(this.canvas.width!==a.width||this.canvas.height!==a.height)this.canvas.width=a.width,this.canvas.height=a.height;return this.canvas},putImageDataToCanvas:function(a){return this.getCanvas(a),this.context.putImageData(a,0,0),this.canvas},drawToCanvas:function(a){return this.getCanvas(a),this.context.drawImage(a,0,0),this.canvas},receive:function(a){var b=Iframework.util.type(a),c=this,d,e,f;if(this.node.view.Native&&b==="ImageData")d||(d=c.putImageDataToCanvas(a)),a=e;else if(!this.node.view.Native&&b!=="ImageData"){if(!a.getContext||!a.getContext("2d"))e||(e=this.drawToCanvas(a),a=e);f||(f=a.getContext("2d").getImageData(0,0,a.width,a.height)),a=f}var g={};g[this.id]=a,this.node.receive(g)}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){Iframework.PortOut=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortOutView({model:this})},send:function(a){this.Edges.each(function(b){_.defer(function(){b.Target.receive(a)})})}}),Iframework.PortsOut=Backbone.Collection.extend({model:Iframework.PortOut})}),$(function(){var a='<div class="portshown portshown-out"><span class="label"><%= name %></span><span class="hole hole-out hole-<%= type_class %> icon-logout"></span></div><span class="plugend plugend-out plugend-<%= type_class %>"></span>';Iframework.PortOutView=Iframework.PortView.extend({tagName:"div",className:"port",portOutTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect"},render:function(){this.$el.html(this.portOutTemplate(this.model.toJSON())),this.$el.addClass("port-out"),this.$(".hole").draggable({helper:function(a){return $('<span class="holehelper holehelper-in" />')}}),this.$(".plugend").draggable({helper:function(a){return $('<span class="plugendhelper plugendhelper-out" />')}}),this.$(".hole").data({model:this.model});var a="",b=this.model.get("type_class");b==="all"?a=".hole-in, .plugend-out":(a=".hole-in.hole-all, .hole-in.hole-"+b+", .plugend-out.plugend-all, .plugend-out.plugend-"+b,a+=", .hole-in.hole-bang, .plugend-out.plugend-string");if(b==="int"||b==="float"||b==="number")a+=", .hole-in.hole-string, .plugend-out.plugend-string",a+=", .hole-in.hole-int, .hole-in.hole-float, .hole-out.hole-number, .plugend-out.plugend-int, .plugend-out.plugend-float, .plugend-out.plugend-number";this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.graph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+8+$(".graph").scrollTop(),e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a,b){this.model.node.graph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=undefined,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")]});g.graph=this.model.graph,Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.graph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a,b){this.model.node.graph.view.maskFrames();var c=this.topConnectedEdge();if(!c)return!1;this.unpluggingEdge=c,this.unpluggingEdge.view.dim(),this.relatedEdges().length===1&&this.$(".plugend").hide();var d=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",d),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var e=new Iframework.EdgeView;e.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=e,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+$(".graph").scrollLeft(),d=b.offset.top+6+$(".graph").scrollTop(),e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.graph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn,d=this.model.get("name"),e=this.popupTemplate(this.model.toJSON());e=$(e),this.$el.append(e),e.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var f=this.model.get("type").substring(0,3);$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(e.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);e.append(b)},this),$(".disconnect").button({icons:{primary:"icon-scissors"},text:!1})),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},disconnect:function(a){var b=this.model.graph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.graph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+$(".graph").scrollLeft():0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+$(".graph").scrollTop():0},_relatedEdges:null,relatedEdges:function(){return this._relatedEdges===null&&(this._relatedEdges=this.model.graph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)}})}),$(function(){Iframework.PortOutImage=Iframework.PortOut.extend({getCanvas:function(a){this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"));if(this.canvas.width!==a.width||this.canvas.height!==a.height)this.canvas.width=a.width,this.canvas.height=a.height;return this.canvas},putImageDataToCanvas:function(a){return this.getCanvas(a),this.context.putImageData(a,0,0),this.canvas},drawToCanvas:function(a){return this.getCanvas(a),this.context.drawImage(a,0,0),this.canvas},send:function(a){var b=Iframework.util.type(a),c=this,d,e,f;this.Edges.each(function(g){_.defer(function(){if(g.Target.node.view.Native&&b==="ImageData")d||(d=c.putImageDataToCanvas(a)),g.Target.receive(d);else if(!g.Target.node.view.Native&&b!=="ImageData"){if(!a.getContext||!a.getContext("2d"))e||(e=c.drawToCanvas(a),a=e);f||(f=a.getContext("2d").getImageData(0,0,a.width,a.height)),g.Target.receive(f)}else g.Target.receive(a)})})}})}),$(function(){Iframework.Module=Backbone.Model.extend({defaults:{src:"",info:{}},initialize:function(){},initializeView:function(){return this.view||(this.view=new Iframework.ModuleView({model:this})),this.view},toJSON:function(){return{src:this.get("src"),info:this.get("info")}}}),Iframework.Modules=Backbone.Collection.extend({model:Iframework.Module,findOrAdd:function(a){var b;return b=this.find(function(b){return b.get("src")===a.get("src")}),b||(b=new Iframework.Module({node:a}),this.add(b)),b}})}),$(function(){var a='<div class="addnode button icon-window" title="drag to graph"></div><h2 class="title"><%= info.title %></h2><p class="description"><%= info.description %></p><p class="src"><%= src %></p>';Iframework.ModuleView=Backbone.View.extend({tagName:"div",className:"library-module",template:_.template(a),events:{"click .addnode":"addNode","dragstart .addnode":"dragStart","dragstop .addnode":"dragStop"},initialize:function(){return this.render(),this.$(".addnode").data({module:this.model}).draggable({helper:function(){var a=$('<div class="addnode-drag-helper" />').data({"meemoo-drag-type":"library-module"}).text($(this).data("module").get("info").title);return $(".app").append(a),a}}),this},render:function(){this.$el.html(this.template(this.model.toJSON()))},addNode:function(a){Iframework.$(".addbyurlinput").val(this.model.get("src")),Iframework.addByUrl(a)},dragAddNode:function(a){a.src=this.model.get("src"),Iframework.shownGraph.addNode(a)},dragStart:function(){Iframework.shownGraph.view.maskFrames()},dragStop:function(){Iframework.shownGraph.view.unmaskFrames()}})}),$(function(){Iframework.Edge=Backbone.Model.extend({defaults:{source:[0,"default"],target:[0,"default"]},initialize:function(){},initializeView:function(){return this.view=new Iframework.EdgeView({model:this}),this.view},Source:null,Target:null,connectTryCount:5,connected:!1,connect:function(){try{this.Source=this.graph.get("nodes").get(this.get("source")[0]).Outputs.get(this.get("source")[1]),this.Target=this.graph.get("nodes").get(this.get("target")[0]).Inputs.get(this.get("target")[1])}catch(a){console.warn("Edge source or target port not found, try #"+this.connectTryCount+": "+this.toString());if(this.connectTryCount>0){this.connectTryCount--;var b=this;_.delay(function(){b.connect()},1e3)}return!1}return!this.Source||!this.Target?!1:(this.Source.connect(this),this.Target.connect(this),this.Source.node.receive({connect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.graph.view&&this.graph.view.addEdge(this),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.connectEdge(this),this.connected=!0,this)},disconnect:function(){this.Source&&this.Target&&(this.Source.disconnect(this),this.Target.disconnect(this),this.Source.node.receive({disconnect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.disconnectEdge(this)),this.view&&this.view.remove(),this.connected=!1},remove:function(){this.graph.removeEdge(this)},toString:function(){return this.get("source")[0]+":"+this.get("source")[1]+"->"+this.get("target")[0]+":"+this.get("target")[1]}}),Iframework.Edges=Backbone.Collection.extend({model:Iframework.Edge})}),$(function(){Iframework.EdgeView=Backbone.View.extend({tagName:"div",className:"edge",positions:null,graphSVGElement:null,elementGroup:null,elementWire:null,elementShadow:null,isPreview:!1,initialize:function(){this.graphSVGElement=document.getElementById("edgesSvg"),this.positions={fromX:0,fromY:0,toX:0,toY:0},this.model||(this.isPreview=!0),this.model&&this.model._color&&(this._color=this.model._color),this.render(),this.model&&(this._z=this.model.graph.edgeCount++,$(this.elementWire).data({model:this.model}).click(function(a){$(a.target).data("model").view.click(a)}))},render:function(){return this.calcPositions(),this.elementGroup=this.makeSVG("g",{transform:"translate("+this.svgX()+","+this.svgY()+")","class":"wire-group"+(this.isPreview?" preview":"")}),this.elementShadow=this.makeSVG("path",{"class":"wire-shadow",d:this.svgPathShadow()}),this.elementWire=this.makeSVG("path",{"class":"wire",d:this.svgPath(),stroke:this.color()}),this.elementGroup.appendChild(this.elementShadow),this.elementGroup.appendChild(this.elementWire),this.graphSVGElement.appendChild(this.elementGroup),this.model&&(this.model.Source.view.$(".plugend").show(),this.model.Target.view.$(".plugend").show()),this},redraw:function(){this.calcPositions(),$(this.elementGroup).attr("transform","translate("+this.svgX()+", "+this.svgY()+")"),$(this.elementWire).attr("d",this.svgPath()),$(this.elementShadow).attr("d",this.svgPathShadow())},remove:function(){$(this.elementGroup).remove()},setPositions:function(a){this.positions=a},calcPositions:function(){if(this.model){var a=this.model.get("source")[1],b=this.model.get("target")[1];this.positions.fromX=this.model.Source.view.portOffsetLeft("out",a),this.positions.fromY=this.model.Source.view.portOffsetTop("out",a),this.positions.toX=this.model.Target.view.portOffsetLeft("in",b),this.positions.toY=this.model.Target.view.portOffsetTop("in",b)}},svgX:function(){return Math.min(this.positions.toX,this.positions.fromX)-50},svgY:function(){return Math.min(this.positions.toY,this.positions.fromY)-25},svgW:function(){return Math.abs(this.positions.toX-this.positions.fromX)+100},svgH:function(){return Math.abs(this.positions.toY-this.positions.fromY)+50},pathStraight:35,pathCurve:60,svgPath:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY(),c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY();return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},svgPathShadow:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY()+1,c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY()+1;return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},color:function(){return this._color?this._color:this.model?this._color=Iframework.getWireColor():Iframework.wireColors[Iframework.wireColorIndex]},setColor:function(a){this._color=a,$(this.elementWire).attr("stroke",a)},label:function(){return this.model.get("source")[0]+":"+this.model.get("source")[1]+'<span class="wiresymbol" style="color:'+this._color+'">&rarr;</span>'+this.model.get("target")[0]+":"+this.model.get("target")[1]},makeSVG:function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)d==="xlink:href"?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c},dim:function(){$(this.elementGroup).attr("opacity",.2)},undim:function(){$(this.elementGroup).attr("opacity",1)},click:function(a){this._z<this.model.graph.edgeCount-1&&(this.graphSVGElement.appendChild(this.elementGroup),this._z=this.model.graph.edgeCount++),this.highlight()},highlight:function(){var a=$(this.elementShadow);a.attr("class","wire-shadow highlight"),setTimeout(function(){a.attr("class","wire-shadow")},1e3),this.model.Source.view&&this.model.Source.view.highlight(),this.model.Target.view&&this.model.Target.view.highlight()}})}),$(function(){var a=Backbone.Router.extend({routes:{"example/:url":"loadExample","new":"newBlank","local/:url":"loadLocal","gist/https://gist.github.com/:user/:id":"loadGistUgly","gist/:id":"loadGist","*path":"default"},loadExample:function(a){Iframework.loadExample(a)},loadGistUgly:function(a){this.navigate("gist/"+a,{replace:!0}),this.loadGist(a)},loadLocal:function(a){Iframework.loadLocal(a)},loadGist:function(a){Iframework.loadFromGistId(a)},newBlank:function(){Iframework.newBlank()},"default":function(){}});Iframework.router=new a,Backbone.history.start()}),function(a){var b=$('<div><div class="sourceedit"><textarea /></div><div class="controls"><button class="button sourcerefresh icon-cw" title="refresh the source code">refresh</button><button class="button sourcecompress icon-bag" title="refresh and compress the source code into one line">compress</button><button class="button sourceapply icon-ok" title="reloads the app">apply changes</button></div></div>'),c=b.find("textarea");a.addMenu("source",b,"icon-cog"),a.on("change",function(b){if(a.shownGraph&&a.$(".menu-source").is(":visible")){var d=c.prop("scrollTop");c.val(JSON.stringify(a.shownGraph.toJSON(),null,"  ")),c.scrollTop(d)}});var d=function(){c.val(JSON.stringify(a.shownGraph,null,"  "))};b.find(".sourcerefresh").click(d),a.on("showmenu:source",d);var e=function(){c.val(JSON.stringify(a.shownGraph,null,""))};b.find(".sourcecompress").click(e);var f=function(){var b;try{b=JSON.parse(c.val())}catch(e){return!1}if(b){var f=a.loadGraph(b);a._loadedLocalApp=null,d(),f.trigger("change")}return!1};b.find(".sourceapply").click(f)}(Iframework),function(a){var b=$('<div><div class="controls"><form class="addbyurl"><input class="addbyurlinput" name="addbyurlinput" placeholder="search or url" type="text" /><button class="addbyurlsubmit icon-ok" type="submit">load</button></form></div><div class="listing"></div></div>');a.addMenu("library",b,"icon-plus"),a.loadLibrary=function(c){var d=[],e=$("<div></div>");for(var f in c){if(!c.hasOwnProperty(f))continue;var g=$('<div class="library-section"></div>');g.append($('<h3><a href="#">'+f+"</a></h3>"));var h=$("<div></div>"),i=c[f];for(var j=0;j<i.length;j++){var k=new a.Module(i[j]);k.initializeView(),h.append(k.view.$el);var l={value:k.get("src"),label:k.get("info").title+" - "+k.get("info").description+" - "+k.get("src"),title:k.get("info").title,description:k.get("info").description+" - "+k.get("src")};d.push(l)}g.append(h),e.append(g)}b.find(".listing").append(e),e.children(".library-section").accordion({animate:!1,header:"h3",heightStyle:"content",collapsible:!0,active:!1}),b.find(".addbyurlinput").autocomplete({minLength:1,source:d,select:function(b,c){_.defer(function(){a.addByUrl()})}}).data("ui-autocomplete")._renderItem=function(a,b){return $("<li>").append('<a><span style="font-size:120%;">'+b.title+"</span><br>"+b.description+"</a>").appendTo(a)}};var c=a.addByUrl=function(){var b=a.$(".addbyurlinput");b.blur();var c=b.val();if(c!==""){var d=a.$(".graph");a.shownGraph.addNode({src:c,x:Math.floor(d.scrollLeft()+d.width()/2)-100,y:Math.floor(d.scrollTop()+d.height()/2)-100}),b.val("").attr("placeholder","loading..."),window.setTimeout(function(){b.attr("placeholder","search or url")},1e3)}return!1};b.find(".addbyurl").submit(function(){return c(),!1})}(Iframework),function(a){var b="AaqPpE9LORQel03S9cCl7z",c="http://i.meemoo.me/";window.URL||(window.URL=window.webkitURL||window.msURL||window.oURL||!1);var d=$('<div class="meemoo-plugin-images"><h2>Local images (not saved)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="fileinput" accept="image/*" multiple /></span><button class="localfile icon-camera" title="Not public. From computer (or mobile camera).">Choose local image</button> from computer or mobile camera<div class="image-drop local-drop"><div class="drop-indicator"><p>drag image here to hold it</p></div></div><div class="local-listing"></div><h2>Public images</h2><button class="publicfile icon-globe-1" title="Upload image to Meemoo from computer, URL, Flickr, Google, Dropbox...">Upload image</button> from computer, Flickr, G, Db, etc.<div class="info"></div><div class="image-drop public-drop"><div class="drop-indicator"><p>drag image here to save to web</p></div></div><div class="public-listing"></div></div>');a.addMenu("images",d,"icon-picture");var e=d.find(".info"),f=function(a){e.text(a)};yepnope({load:"http://api.filepicker.io/v1/filepicker.js",complete:function(){window.filepicker?filepicker.setKey(b):f("Offline or image service not available.")}}),a.$(".showpanel .show-images").droppable({accept:".canvas",tolerance:"pointer",activeClass:"drop-indicator",over:function(a,b){$(this).trigger("click")}}),d.find(".image-drop").droppable({accept:".canvas",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),d.find(".local-drop").on("drop",function(a,b){var c=b.helper.data("meemoo-drag-canvas");if(!c)return!1;var d=g(c);j.append(d)});var g=function(a){var b=$('<div class="meemoo-plugin-images-thumbnail canvas">').append(a).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(b){var c=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":a});return $(document.body).append(c),_.delay(function(){h(c)},100),c}});return b},h=function(a){if(!a)return;var b=a.data("meemoo-source-image"),c=document.createElement("canvas");c.width=b.naturalWidth?b.naturalWidth:b.width,c.height=b.naturalHeight?b.naturalHeight:b.height,c.getContext("2d").drawImage(b,0,0),a.data("meemoo-drag-canvas",c),a.append(c)},i=d.find(".fileinput"),j=d.find(".local-listing");i.change(function(a){var b=a.target.files;for(var c=0;c<b.length;c++){var d=new Image;d.src=window.URL.createObjectURL(b[c]);var e=g(d);j.append(e)}}),d.find(".localfile").click(function(){i.trigger("click")});var k=d.find(".public-listing");d.find(".publicfile").click(function(){if(!window.filepicker)return f("Image service not yet available."),!1;filepicker.pickAndStore({mimetype:"image/*",multiple:!0,maxSize:5242880},{location:"S3",path:"v1/in/",access:"public"},function(b){for(var c=0;c<b.length;c++){var d={main:b[c]},e=new a.plugins.images.GalleryImage({files:d});m.add(e),e.save()}})}),d.find(".public-drop").on("drop",function(b,c){if(!window.filepicker)return f("Image service not yet available."),!1;var d=c.helper.data("meemoo-drag-canvas");if(!d)return!1;var e;try{e=d.toDataURL().split(",",2)[1]}catch(g){return f('Not able to get image data. Right-click "Save as..." or take a screenshot.'),!1}f("Uploading..."),filepicker.store(e,{mimetype:"image/png",location:"S3",path:"v1/out/",filename:"meemoo.png",access:"public",base64decode:!0},function(b){var c={main:b},d=new a.plugins.images.GalleryImage({files:c});m.add(d),d.save(),f("Upload done :-)"),_.delay(function(){f("")},2e3)},function(a){f("Upload error :-(")},function(a){f(a+"% uploaded.")})}),a.plugins.images={},a.plugins.images.GalleryImage=Backbone.Model.extend({initialize:function(){this.mainsrc=c+this.get("files").main.key,this.initializeView()},initializeView:function(){return this.view||(this.view=new a.plugins.images.GalleryImageView({model:this})),this.view},toJSON:function(){return{id:this.id,files:this.get("files")}}}),a.plugins.images.GalleryImages=Backbone.Collection.extend({model:a.plugins.images.GalleryImage,localStorage:new Backbone.LocalStorage("GalleryImages")});var l='<img crossorigin="anonymous" title="drag to graph or image node" /><div class="controls"><a class="link button icon-link" title="Open image in new window" target="_blank"></a><button class="export-public icon-export" title="Save straight to Flickr, Dropbox, Google, Facebook..."></button><button class="delete icon-trash" title="Delete image"></button></div>';a.plugins.images.GalleryImageView=Backbone.View.extend({tagName:"div",className:"meemoo-plugin-images-thumbnail",template:_.template(l),events:{"click .export-public":"exportPublic","click .delete":"destroyModel"},initialize:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".link").attr("href",this.model.mainsrc);var a=this.$("img")[0];return a.src=this.model.mainsrc,this.$el.draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(b){var c=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":a,"meemoo-image-url":a.src});return $(document.body).append(c),_.delay(function(){h(c)},100),c}}),k.append(this.el),this.model.on("destroy",this.remove,this),this},exportPublic:function(){if(!window.filepicker)return f("Image service not available."),!1;var a=this.model.get("files").main.url;filepicker.exportFile(a,{mimetype:"image/png"},function(a){})},destroyModel:function(){if(window.confirm("Are you sure you want to delete this image?")){if(window.filepicker){var a=this.model.get("files").main;filepicker.remove(a,function(){})}this.model.destroy()}},remove:function(){this.$el.remove()}});var m=new a.plugins.images.GalleryImages;m.fetch({success:function(a){m.each(function(a){a.initializeView()})},error:function(a){console.warn("error loading public images")}})}(Iframework),$(function(){Iframework.allLoaded(),Mousetrap.bind(["command+a","ctrl+a"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework._enableKeyBindings&&(a.preventDefault(),Iframework.shownGraph.view.selectAll())}),Mousetrap.bind(["command+x","ctrl+x"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework._enableKeyBindings&&Iframework.shownGraph.view.cut()}),Mousetrap.bind(["command+c","ctrl+c"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework._enableKeyBindings&&Iframework.shownGraph.view.copy()}),Mousetrap.bind(["command+v","ctrl+v"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework._enableKeyBindings&&Iframework.shownGraph.view.paste()})});